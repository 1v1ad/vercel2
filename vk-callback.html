<!DOCTYPE html>
<meta charset="utf-8">
<style>
  html,body{margin:0;height:100%;display:flex;align-items:center;justify-content:center;
            background:#18181f;color:#ffbb00;font-family:Arial,sans-serif;text-align:center}
</style>
<div id="info">Авторизация завершается…</div>

<script>
(async () => {
  if (localStorage.getItem('authToken')) {
    location.href = '/lobby.html';          // уже авторизованы
    return;
  }

  const params = new URLSearchParams(location.search);
  const code         = params.get('code');
  const deviceId     = params.get('device_id');
  const codeVerifier = params.get('code_verifier');

  if (!code || !deviceId) {
    document.getElementById('info').textContent = 'Ошибка: не получен код авторизации';
    return;
  }

  try {
    const r = await fetch('https://vercel2pr.onrender.com/api/auth/vk-callback', {
      method :'POST',
      headers:{'Content-Type':'application/json'},
      body   :JSON.stringify({ code, deviceId, codeVerifier })
    });

    if (!r.ok) {
      const e = await r.json().catch(()=>({error:'fail'}));
      document.getElementById('info').textContent = 'Ошибка: ' + (e.error_description||e.error);
      return;
    }

    const { token } = await r.json();
    localStorage.setItem('authToken', token);
    location.href = '/lobby.html';
  } catch (e) {
    document.getElementById('info').textContent = 'Сбой: ' + e.message;
  }
})();
</script>

<!-- флаг, чтобы SDK не инициировался во всплывашке -->
<script>window.VKIDSDKInit = () => {};</script>
