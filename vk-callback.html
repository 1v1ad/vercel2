<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>VK callback</title>

<script>
(async () => {
  const qs   = new URLSearchParams(location.search);
  const code = qs.get('code');
  if (!code) return document.body.textContent = 'Нет кода авторизации';

  try {
    const r = await fetch(
      'https://vercel2pr.onrender.com/api/auth/vk-callback',
      {
        method :'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          code,
          deviceId    : qs.get('device_id'),
          codeVerifier: qs.get('code_verifier')
        })
      });
    if (!r.ok) throw await r.text();

    const { token } = await r.json();
    localStorage.setItem('authToken', token);

    document.body.textContent = 'Авторизация завершена, переходим…';
    setTimeout(() => location.href = '/lobby.html', 500);

  } catch (e) {
    document.body.textContent = 'Ошибка авторизации: ' + e;
  }
})();
</script>
</head>
<body style="font:18px/1.4 Arial;text-align:center;margin-top:40vh;color:#ffbb00">
Загрузка …
</body>
</html>
