<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>Вход через VK ID</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <!-- ✓ Внешние файлы можно убрать — всё нужное в <style> ниже -->
  <!-- <link rel="stylesheet" href="css/index.css"> -->

  <!-- ✓ Единственный скрипт VK ID One-Tap -->
  <script src="https://unpkg.com/@vkid/sdk@2.6/dist/umd/index.js"
          defer crossorigin="anonymous"></script>

  <style>
    /* минимальная стилизация, всё в одном файле */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      display:flex;align-items:center;justify-content:center;
      background:#1c1b23;color:#ffb840;font:16px/1.4 Inter,Arial,sans-serif}
    .box{
      width:380px;padding:36px 48px;text-align:center;
      background:#2a2733;border:4px solid #ffb840;border-radius:12px;
      box-shadow:0 0 28px rgba(255,184,64,.25)}
    h1{margin:0 0 24px;color:#ff4242;font-size:26px}
    #msg{margin-top:24px;font-size:15px}
  </style>
</head>
<body>

  <div class="box">
    <h1>Вход через VK</h1>
    <!-- !!! без этого div кнопка не появится -->
    <div id="vk_container"></div>
    <p id="msg"></p>
  </div>

  <script defer>
  /* ======= конфигурация ======= */
  const APP_ID   = 54008517;                                      // VK-ID приложения
  const REDIRECT = 'https://sweet-twilight-63a9b6.netlify.app/vk-callback.html';
  const API_URL  = 'https://vercel2pr.onrender.com/api';

  document.addEventListener('DOMContentLoaded', () => {
    /* 1. Инициализируем SDK */
    VKID.Config.init({
      app: APP_ID,
      redirectURI: REDIRECT,
      source: VKID.ConfigSource.ONE_TAP
    });

    /* 2. Рисуем кнопку One-Tap */
    new VKID.OneTap().render({
      container: document.getElementById('vk_container'),
      scheme:'dark',
      buttonStyles:{
        height:44,borderRadius:12,
        backgroundColor:'#0054FF',hoverColor:'#0E63FF',
        activeColor:'#0048DD',textColor:'#FFFFFF'}
    });

    /* 3. Подписываемся на успешную авторизацию */
    safeAuthSubscribe('AUTH_COMPLETE', ({ detail }) => sendCode(detail));

    /* 4. Ошибки виджета */
    VKID.Events.subscribe(
      VKID.WidgetEvents.ERROR,
      e => show(`Ошибка: ${e?.text||'unknown'}`)
    );
  });

  /* ---------- helpers ---------- */
  function safeAuthSubscribe(evt, cb){
    const { Auth={} } = VKID;
    if (!Auth.subscribe) return;         // метод отсутствует — старая версия
    try{  Auth.subscribe(evt, cb);  }    // (event, cb)
    catch{ try{ Auth.subscribe(cb, evt);}catch{} }  // (cb, event)
  }

  async function sendCode({ code, device_id:deviceId, code_verifier:codeVerifier }){
    show('Загрузка …');
    try{
      const r = await fetch(`${API_URL}/auth/vk-callback`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ code, deviceId, codeVerifier })
      });
      if(!r.ok) throw await r.json();
      const { token } = await r.json();
      localStorage.setItem('authToken', token);
      location.href = '/lobby.html';
    }catch(e){
      show(`Ошибка авторизации: ${JSON.stringify(e)}`);
    }
  }

  function show(t){
    const el = document.getElementById('msg');
    if (el) el.textContent = t;
  }
  </script>
</body>
</html>
