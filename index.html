<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>GGRoom — Главная</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0f14; color:#e6e9ef; }
    .wrap { max-width:960px; margin:0 auto; padding:24px; }
    .card { background:#111826; border:1px solid #1f2a3a; border-radius:16px; padding:24px; box-shadow: 0 5px 30px rgba(0,0,0,.25); }
    h1 { font-size:28px; margin:0 0 16px; }
    p { margin:8px 0 16px; color:#9fb0c5; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .btn {
      display:inline-flex; align-items:center; gap:10px; padding:14px 18px; border-radius:12px;
      background:#1b2433; border:1px solid #2a3952; color:#e6e9ef; text-decoration:none; cursor:pointer;
      transition:.15s transform, .15s background;
    }
    .btn:hover { background:#223048; transform:translateY(-1px); }
    .vk { background:#2a3b69; border-color:#3f58a1; }
    .vk:hover { background:#334881; }
    .tg { background:#295a67; border-color:#3f8fa3; }
    .tg:hover { background:#2f6a79; }
    .muted { color:#8ea1b5; font-size:14px; }
    .nav { display:flex; gap:10px; margin-top:16px; }
    .nav a { color:#9fc6ff; text-decoration:none; }
    .nav a:hover { text-decoration:underline; }
    .foot { margin-top:24px; font-size:12px; color:#6f7d90; }
    code { background:#0f1520; padding:2px 6px; border-radius:6px; border:1px solid #1b2433; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>GGRoom</h1>
      <p>Войдите через VK ID или Telegram. Склейка аккаунтов идёт <em>тихо</em> по <code>device_id</code>, чтобы не мучить людей кодами.</p>

      <div class="row" style="margin:18px 0 8px">
        <button id="btnVK" class="btn vk">Войти через VK ID</button>
        <span id="tgMount" class="btn tg" style="padding:0; border:none; background:transparent"></span>
      </div>

      <div class="nav">
        <a href="/lobby.html">→ Лобби</a>
        <a href="/admin/">→ Админка</a>
      </div>

      <div class="foot">
        <div>API: <code id="apiVal"></code></div>
        <div>Device ID: <code id="didVal"></code></div>
      </div>
    </div>
  </div>

  <script>
    // === Конфиг фронта ===
    const API = 'https://vercel2pr.onrender.com';           // ваш Render API
    const TG_BOT_USERNAME = 'GGR00m_bot';                   // из .env
    const DEVICE_ID_KEY = 'gg_device_id';

    document.getElementById('apiVal').textContent = API;

    // === Генерация и хранение device_id ===
    function uuid4() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    function ensureDeviceId() {
      let did = localStorage.getItem(DEVICE_ID_KEY);
      if (!did) { did = uuid4(); localStorage.setItem(DEVICE_ID_KEY, did); }
      return did;
    }
    const DEVICE_ID = ensureDeviceId();
    document.getElementById('didVal').textContent = DEVICE_ID;

    // === ВК ===
    document.getElementById('btnVK').addEventListener('click', () => {
      const url = `${API}/api/auth/vk/start?did=${encodeURIComponent(DEVICE_ID)}`;
      location.href = url;
    });

    // === Телеграм-виджет (динамически, чтобы подставить ?did=...) ===
    function mountTelegramWidget() {
      const mount = document.getElementById('tgMount');
      mount.innerHTML = ''; // на всякий
      const s = document.createElement('script');
      s.async = true;
      s.src = 'https://telegram.org/js/telegram-widget.js?22';
      s.setAttribute('data-telegram-login', TG_BOT_USERNAME);
      s.setAttribute('data-size', 'large');
      s.setAttribute('data-userpic', 'false');
      // Очень важно: data-auth-url с нашим did, бек его учтёт
      s.setAttribute('data-auth-url', `${API}/api/auth/tg/callback?did=${encodeURIComponent(DEVICE_ID)}`);
      s.setAttribute('data-request-access', 'write');
      mount.appendChild(s);
    }
    mountTelegramWidget();

    // Если VK/TG вернул нас с ?logged=1 — мягко кидаем в лобби
    const q = new URLSearchParams(location.search);
    if (q.get('logged') === '1') {
      setTimeout(() => location.replace('/lobby.html'), 150);
    }
  </script>
</body>
</html>
