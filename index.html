<!-- ... [всё до скрипта без изменений] ... -->
<script type="text/javascript">
  if ('VKIDSDK' in window) {
    const VKID = window.VKIDSDK;

    VKID.Config.init({
      app: 53969710,
      redirectUrl: 'https://sweet-twilight-63a9b6.netlify.app/vk-callback.html',
      responseMode: VKID.ConfigResponseMode.Callback,
      source: VKID.ConfigSource.ONE_TAP,
      scope: ''
    });

    const oneTap = new VKID.OneTap();

    oneTap.render({
      container: document.getElementById("vk_container"),
      scheme: 'dark',
      showAlternativeLogin: true,
      oauthList: ['mail_ru']
    })
    .on(VKID.WidgetEvents.ERROR, vkidOnError)
    .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, async function (payload) {
      const code = payload.code;
      const deviceId = payload.device_id;

      // Отправляем на backend для обмена на JWT и профиль
      const resp = await fetch("https://vercel2pr.onrender.com/api/auth/vk-callback", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ code, deviceId })
      });
      if (resp.ok) {
        const { token, user } = await resp.json();
        localStorage.setItem("authToken", token);
        window.location.href = "/lobby.html";
      } else {
        vkidOnError({ text: "Ошибка авторизации. Попробуйте снова." });
      }
    });

    function vkidOnSuccess(data) {
      // НЕ нужен — теперь логика только через backend!
    }

    function vkidOnError(error) {
      let msg = 'Нажмите <b>«Войти с VK ID»</b>, а затем введите полученный от ВКонтакте код';
      if (error && error.text === 'timeout') {
        msg = "⏳ Не удалось быстро войти.<br>Попробуйте ещё раз или войдите вручную.<br><br>Нажмите <b>«Войти с VK ID»</b>, а затем введите полученный от ВКонтакте код";
      } else if (error) {
        msg = "Ошибка авторизации.<br>Попробуйте снова.<br><br>Нажмите <b>«Войти с VK ID»</b>, а затем введите полученный от ВКонтакте код";
      }
      document.getElementById("login-message").innerHTML = msg;
    }
  }
</script>
<!-- ... -->
