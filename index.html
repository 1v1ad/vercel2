<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GGRoom ‚Äî –≤—Ö–æ–¥</title>
  <style>
    :root {
      --bg: #0b0f15;
      --card: #171923;
      --border: #2a2f3a;
      --accent: #ffb300;
      --vk: #2787F5;
      --text: #e9eef7;
      --muted: #a6b0c0;
      --danger: #ff4d4d;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex; align-items:center; justify-content:center; padding:16px;
    }
    .wrap { width:100%; max-width: 560px; }
    .card{
      position:relative;
      background: radial-gradient(120% 120% at 10% 0%, #1b1f2b 0%, #121622 60%, #0e1220 100%);
      border:1px solid var(--border);
      border-radius: 20px;
      padding: 28px 22px;
      box-shadow:
        0 0 0 2px rgba(255,179,0,.15) inset,
        0 20px 40px rgba(0,0,0,.45),
        0 0 60px rgba(255,179,0,.15);
      outline: 3px solid rgba(255,179,0,.25);
      outline-offset: 6px;
    }
    .title{
      margin:0 0 18px;
      font-size: 28px;
      font-weight: 800;
      text-align:center;
      color:#ff4040; /* –∫–∞–∫ –Ω–∞ —Ç–≤–æ—ë–º —Å–∫—Ä–∏–Ω–µ ‚Äî –∫—Ä–∞—Å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
      letter-spacing:.3px;
    }
    .hint{
      margin-top:12px; text-align:center; color:var(--muted); font-size:13px;
    }
    .btn{
      display:flex; align-items:center; justify-content:center; gap:10px;
      width:100%; padding:16px 18px; border:none; cursor:pointer;
      border-radius: 14px; background: var(--vk); color:#fff; font-weight:700; font-size:16px;
      box-shadow: 0 12px 24px rgba(39,135,245,.35), 0 0 0 2px rgba(255,255,255,.06) inset;
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
    }
    .btn:hover{ filter: brightness(1.05); }
    .btn:active{ transform: translateY(1px); }
    .vk-icon{
      width:22px; height:22px; border-radius:6px; background:#fff; color:#2787F5;
      display:flex; align-items:center; justify-content:center; font-weight:900;
    }
    .avatar{
      width:24px; height:24px; border-radius:50%; background:#00000030;
      display:none; /* –æ—Ç–æ–±—Ä–∞–∑–∏–º, –∫–æ–≥–¥–∞ —É–∑–Ω–∞–µ–º –∏–º—è/–∞–≤–∞—Ç–∞—Ä –∏–∑ LocalStorage (–ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤–∏–∑–∏—Ç–µ) */
    }
    .badge{
      display:block; text-align:center; color:#ffc46b; font-size:12px; margin-top:8px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">–í—Ö–æ–¥ —á–µ—Ä–µ–∑ VK</h1>
      <button id="vk-login" class="btn">
        <span class="vk-icon">vk</span>
        <span id="vk-caption">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å VK</span>
        <img id="vk-ava" class="avatar" alt="">
      </button>
      <div class="badge">–ù–∞–∂–º–∏—Ç–µ ¬´–í–æ–π—Ç–∏ —Å VK ID¬ª, –∑–∞—Ç–µ–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—Ö–æ–¥</div>
      <div class="hint">–ü—Ä–æ–¥–æ–ª–∂–∞—è, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ —Å–µ—Ä–≤–∏—Å–∞.</div>
    </div>
  </div>

  <script src="./js/pkce.js"></script>
  <script>
    const VK_CLIENT_ID = 54008517;
    const REDIRECT_URI = 'https://sweet-twilight-63a9b6.netlify.app/vk-callback.html';

    // –ï—Å–ª–∏ —É –Ω–∞—Å —É–∂–µ –∫–æ–≥–¥–∞-—Ç–æ –±—ã–ª –ø—Ä–æ—Ñ–∏–ª—å ‚Äî –∫—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç –∏ –∞–≤–∞—Ç–∞—Ä –Ω–∞ –∫–Ω–æ–ø–∫–µ
    try {
      const cached = JSON.parse(localStorage.getItem('vk_cached_user') || 'null');
      if (cached?.firstName) {
        document.getElementById('vk-caption').textContent = `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–∞–∫ ${cached.firstName}`;
      }
      if (cached?.avatar) {
        const ava = document.getElementById('vk-ava');
        ava.src = cached.avatar;
        ava.style.display = 'block';
      }
    } catch {}

    document.getElementById('vk-login').onclick = async () => {
      const { codeVerifier, codeChallenge } = await PKCE.generate();
      const deviceId = PKCE.deviceId();

      sessionStorage.setItem('vk_code_verifier', codeVerifier);
      sessionStorage.setItem('vk_device_id', deviceId);

      const params = new URLSearchParams({
        client_id: String(VK_CLIENT_ID),
        redirect_uri: REDIRECT_URI,
        response_type: 'code',
        scope: 'offline',
        code_challenge: codeChallenge,
        code_challenge_method: 's256',   // üëà —Ñ–∏–∫—Å: —Å—Ç—Ä–æ—á–Ω—ã–º–∏
        state: 'vk_onetap'
      });

      window.location.href = 'https://oauth.vk.com/authorize?' + params.toString();
    };
  </script>
</body>
</html>
