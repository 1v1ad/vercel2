<body>
  <div class="header">
    <h1>VK One Tap Login</h1>
  </div>

  <div class="container" style="display: flex; justify-content: center; margin-top: 50px;">
    <div id="vk_container" style="min-width: 320px;"></div>
  </div>

  <script src="https://unpkg.com/@vkid/sdk@2.10.0/dist-sdk/umd/index.js"></script>
  <script>
    const VKID = window.VKIDSDK;

    VKID.Config.init({
      app: 53969710,
      redirectUrl: window.location.origin + "/api/vk/callback",
      responseMode: VKID.ConfigResponseMode.Code,
      source: VKID.ConfigSource.LOWCODE,
    });

    const oneTap = new VKID.OneTap();

    oneTap.render({
      container: document.getElementById("vk_container"),
      scheme: "light",
      showAlternativeLogin: true,
      oauthList: ["mail_ru"],
    })
    .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, async (payload) => {
      try {
        const response = await fetch("/api/vk/callback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            code: payload.code,
            device_id: payload.device_id,
          }),
        });

        const result = await response.json();

        if (!result || !result.first_name) {
          alert("Ошибка авторизации: получены пустые данные.");
          return;
        }

        localStorage.setItem("user_first_name", result.first_name);
        localStorage.setItem("user_last_name", result.last_name);
        localStorage.setItem("user_avatar", result.photo);

        window.location.href = "/lobby.html";
      } catch (err) {
        alert("Ошибка при отправке данных на сервер.");
      }
    });
  </script>
</body>
