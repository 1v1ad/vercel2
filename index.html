<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Вход через VK ID</title>
  <style>
    :root { color-scheme: dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:#0b0f17; color:#fff;
    }
    .card { width:100%; max-width:420px; background:#121826; border-radius:16px; padding:24px;
      box-shadow:0 10px 30px rgba(0,0,0,0.4); }
    h1 { font-size:22px; margin:0 0 8px; }
    p.muted { color:#9aa3af; font-size:14px; margin:0 0 16px; }
    .btn { width:100%; padding:14px 16px; font-size:16px; border:none; border-radius:12px; cursor:pointer; }
    .vk { background:#2787F5; color:#fff; }
    .hint { color:#9aa3af; font-size:12px; margin-top:10px; text-align:center; }
    .hide { display:none; }
    #status { color:#9aa3af; font-size:14px; margin-top:12px; min-height:1em; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Войдите и начните выигрывать</h1>
    <p class="muted">Авторизация через VK ID. После входа перейдём в лобби.</p>

    <!-- Контейнер под One Tap -->
    <div id="vkid-container"></div>

    <!-- Фолбэк-кнопка -->
    <div id="fallback">
      <button class="btn vk" id="fallbackLogin">Войти через VK ID</button>
      <div class="hint">Если «Продолжить как …» не появилось — нажмите эту кнопку.</div>
    </div>

    <p id="status"></p>
  </div>

  <script>
    // === Твои константы ===
    const API_BASE   = 'https://vercel2pr.onrender.com';
    const VK_CLIENT_ID = 54008517;  // твой app_id из VK ID

    const $status   = document.getElementById('status');
    const $fallback = document.getElementById('fallback');
    const $fallbackLogin = document.getElementById('fallbackLogin');
    const $vkContainer = document.getElementById('vkid-container');

    // Фолбэк: старт авторизации через backend
    function startBackendAuth() {
      window.location.href = API_BASE + '/api/auth/vk/start';
    }
    $fallbackLogin.onclick = startBackendAuth;

    // Если вернулись после логина — сразу в лобби
    const params = new URLSearchParams(location.search);
    if (params.get('logged') === '1') {
      $status.textContent = 'Готово: авторизован. Переходим в лобби...';
      setTimeout(() => { location.href = '/lobby.html'; }, 600);
    }

    // Пытаемся подключить VK ID SDK (браузерный UMD-бандл).
    // Если что-то пойдёт не так — просто оставим фолбэк-кнопку.
    (function loadVKSDK() {
      const script = document.createElement('script');
      // UMD-версия SDK (для браузера). Если когда-то поменяют путь — у нас есть фолбэк.
      script.src = 'https://unpkg.com/@vkid/sdk@latest/dist/umd/index.js';
      script.async = true;
      script.onload = () => {
        try {
          if (!window.VKID || !window.VKID.Auth) throw new Error('VKID not ready');

          // Инициализация SDK. Секреты НЕ нужны — обмен токенов делаем на бэке.
          window.VKID.init({ app: VK_CLIENT_ID });

          // Создаём бренд-кнопку. Если у юзера активная VK-сессия — SDK покажет «Продолжить как …».
          const btn = window.VKID.Auth.createButton({
            style: 'primary',
            action: () => startBackendAuth()
          });

          $vkContainer.appendChild(btn.getElement());

          // Кнопка SDK есть — фолбэк можно спрятать (но оставим как запасной вариант на всякий случай).
          // Комментируй строку ниже, если хочешь, чтобы фолбэк всегда оставался видимым.
          $fallback.classList.add('hide');
        } catch (e) {
          // Тихо оставляем фолбэк
          console.warn('VKID init failed:', e.message);
        }
      };
      script.onerror = () => {
        console.warn('VKID SDK load error — используем фолбэк-кнопку');
      };
      document.head.appendChild(script);
    })();
  </script>
</body>
</html>
