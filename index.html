<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GGRoom — вход</title>
  <style>
    :root { --bg:#0b0d12; --card:#131720; --text:#e8eef5; --muted:#99a3b3; --primary:#6ea8fe; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:linear-gradient(180deg,#0b0d12,#0e121b 35%,#0b0d12); color:var(--text); }
    .wrap { min-height:100dvh; display:grid; place-items:center; padding:24px; }
    .card { width:100%; max-width:720px; background:var(--card); border:1px solid #1d2330; border-radius:16px; padding:28px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 8px; font-size:28px; letter-spacing:.3px; }
    p.lead { margin:0 0 18px; color:var(--muted); }
    .row { display:flex; gap:16px; flex-wrap:wrap; align-items:center; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:14px 16px; border-radius:12px; text-decoration:none; color:#0b0d12; background:var(--text); font-weight:600; border:1px solid transparent; cursor:pointer; }
    .btn:hover { filter:brightness(.96); }
    .btn-ghost { background:transparent; color:var(--text); border-color:#2a3244; }
    .vk { background:#2787F5; color:#fff; }
    .meta { margin-top:14px; font-size:13px; color:var(--muted); }
    .grid { display:grid; gap:18px; grid-template-columns:1fr; }
    @media (min-width:720px){ .grid{ grid-template-columns: 1.2fr .8fr; } }
    .box { padding:16px; border:1px dashed #2a3244; border-radius:12px; }
    code { background:#0c111a; border:1px solid #1b2230; padding:2px 6px; border-radius:6px; }
    .footer { margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>GGRoom</h1>
      <p class="lead">Вход в один клик: VK или Telegram. Склейка гостя и аккаунтов — в фоне, без кодов.</p>

      <div class="grid">
        <div>
          <div class="box">
            <div class="row" style="margin-bottom:14px;">
              <a id="vk-login" class="btn vk" href="#">Войти через VK</a>
              <span style="color:var(--muted);font-size:13px;">или</span>
              <span id="tg-widget-box" class="btn btn-ghost" style="padding:0;border:none;"></span>
            </div>
            <div class="meta">
              Для Телеграма нужен открытый username. Куки <code>sid</code> ставятся httpOnly на бэке.
            </div>
          </div>

          <div class="footer">
            <a class="btn btn-ghost" href="lobby.html">Перейти в лобби</a>
            <!-- ВАЖНО: ведём в существующую админку -->
            <a class="btn btn-ghost" href="admin/">Админка</a>
          </div>
        </div>

        <div>
          <div class="box">
            <div style="font-weight:600;margin-bottom:8px;">Техническое</div>
            <div style="font-size:13px;color:var(--muted);line-height:1.45;">
              <div>API: <code id="cfg-api"></code></div>
              <div>device_id: <code id="cfg-did"></code></div>
              <div>После входа вернётесь с <code>?logged=1</code> — автоматически перейдём в лобби.</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // === КОНФИГ ===
    const API_BASE = (window.API_BASE || 'https://vercel2pr.onrender.com').replace(/\/+$/,'');
    const TG_BOT  = (window.TG_BOT  || 'YOUR_TG_BOT_USERNAME'); // <-- укажи @без собаки

    // device_id — генерируем и храним
    (function ensureDid(){
      try {
        let did = localStorage.getItem('gg_did');
        if (!did) {
          if (crypto && crypto.randomUUID) did = crypto.randomUUID();
          else did = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){const r=Math.random()*16|0;const v=c=='x'?r:(r&0x3|0x8);return v.toString(16);});
          localStorage.setItem('gg_did', did);
        }
        window.gg_did = did;
      } catch(e) { window.gg_did=''; }
    })();

    // VK — используем наш старт-эндпоинт
    (function bindVk(){
      const a = document.getElementById('vk-login');
      if (!a) return;
      a.addEventListener('click', function(ev){
        ev.preventDefault();
        const url = API_BASE + '/api/auth/vk/start?did=' + encodeURIComponent(window.gg_did||'');
        location.href = url;
      });
    })();

    // Telegram — вставляем виджет с ?did=
    (function mountTgWidget(){
      const box = document.getElementById('tg-widget-box');
      if (!box) return;
      if (!TG_BOT || TG_BOT === 'YOUR_TG_BOT_USERNAME') {
        box.innerHTML = '<span style="color:#aaa;font-size:13px;">Укажи TG_BOT на фронте</span>';
        return;
      }
      const s = document.createElement('script');
      s.src = 'https://telegram.org/js/telegram-widget.js?22';
      s.async = true;
      s.setAttribute('data-telegram-login', TG_BOT);
      s.setAttribute('data-size', 'large');
      s.setAttribute('data-radius', '8');
      s.setAttribute('data-userpic', 'false');
      s.setAttribute('data-lang', 'ru');
      s.setAttribute('data-request-access', 'write');
      s.setAttribute('data-auth-url', API_BASE + '/api/auth/tg/callback?did=' + encodeURIComponent(window.gg_did||''));
      box.innerHTML = '';
      box.appendChild(s);
    })();

    // UI
    (function ui(){
      document.getElementById('cfg-api').textContent = API_BASE;
      document.getElementById('cfg-did').textContent = window.gg_did || '';
      const p = new URLSearchParams(location.search);
      if (p.get('logged') === '1') location.replace('lobby.html');
    })();
  </script>
</body>
</html>
