<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Вход через VK ID</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- VK ID SDK v2.6 -->
  <script src="https://unpkg.com/@vkid/sdk@2.6.0/dist-sdk/umd/index.js"></script>

  <link href="https://fonts.googleapis.com/css?family=Inter:700,400&display=swap" rel="stylesheet">
  <style>
    html,body{margin:0;height:100%;font-family:'Inter',Arial,sans-serif;
      background:linear-gradient(135deg,#18181f 0%,#292734 100%);color:#fff}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center}
    .box{background:linear-gradient(150deg,#26232e 60%,#3d2e1d);
      border:3.5px solid #ffbb00e0;border-radius:36px;
      padding:48px 20px 36px;max-width:420px;width:92%;text-align:center;
      box-shadow:0 4px 28px 8px #000a,0 0 32px #ffbb0040 inset;position:relative}
    .box:before{content:"";position:absolute;top:18px;left:18px;right:18px;height:30px;border-radius:22px;
      background:linear-gradient(90deg,#fff4 15%,#fff1 85%,transparent);opacity:.24}
    h1{margin:0 0 26px;font:800 2em 'Inter',sans-serif;color:#fa4242;text-shadow:0 0 8px #42040480}
    #vk_container{margin-top:16px}
    #msg{margin-top:14px;min-height:22px;font-size:15px;color:#ffbb00}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="box">
      <h1>Вход через VK</h1>
      <div id="vk_container"></div>
      <div id="msg">Нажмите <b>«Войти с VK ID»</b>, затем подтвердите вход</div>
    </div>
  </div>

<script>
/* ——— конфигурация ——— */
const API      = 'https://vercel2pr.onrender.com';
const APP_ID   = 54008517;
const REDIRECT = 'https://sweet-twilight-63a9b6.netlify.app/vk-callback.html';

/* ——— инициализация ——— */
document.addEventListener('DOMContentLoaded', () => {
  const VKID = window.VKIDSDK;

  VKID.Config.init({
    app: APP_ID,
    redirectUrl: REDIRECT,
    source: VKID.ConfigSource.ONE_TAP
  });

  /* One-Tap / синяя кнопка */
  new VKID.OneTap().render({
    container: document.getElementById('vk_container'),
    scheme:'dark',
    showAlternativeLogin:false,
    buttonStyles:{
      height:44,borderRadius:12,
      backgroundColor:'#0054ff',hoverColor:'#0e63ff',
      activeColor:'#0048db',textColor:'#ffffff'}
  });

  /* универсальная подписка */
  safeAuthSubscribe('AUTH_COMPLETE', ({ detail }) => sendCode(detail));

  /* ошибки виджета, если объект Events уже загружен */
  if (VKID.Events && VKID.Events.subscribe) {
    VKID.Events.subscribe(
      VKID.WidgetEvents.ERROR,
      e => show('Ошибка: ' + (e?.text || 'unknown'))
    );
  }
});

/* ——— безопасная подписка: ждём инициализации SDK ——— */
function safeAuthSubscribe(eventName, cb) {
  const { Auth } = window.VKIDSDK || {};
  if (!Auth?.subscribe) return;              // метода нет — рано

  let elapsed = 0;
  const STEP  = 150;     // мс
  const LIMIT = 10000;   // 10 с максимум

  const timer = setInterval(() => {
    try {                                // (event , cb)
      Auth.subscribe(eventName, cb);
      clearInterval(timer);
    } catch {
      try {                              // (cb , event)
        Auth.subscribe(cb, eventName);
        clearInterval(timer);
      } catch (e) {
        elapsed += STEP;
        if (elapsed >= LIMIT) {          // бросаем попытки
          clearInterval(timer);
          console.warn(
            'VKID.Auth.subscribe: не удалось за 10 с — событие AUTH_COMPLETE пропущено',
            e
          );
        }
      }
    }
  }, STEP);
}

/* ——— обмен code → JWT ——— */
async function sendCode({ code, device_id, code_verifier }) {
  try {
    const r = await fetch(`${API}/api/auth/vk-callback`, {
      method :'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        code,
        deviceId    : device_id,
        codeVerifier: code_verifier })   // у One-Tap приходит
    });

    if (!r.ok) {
      const e = await r.json().catch(()=>({}));
      return show('Ошибка: ' + (e.error_description||e.error||r.status));
    }
    const { token } = await r.json();
    localStorage.setItem('authToken', token);
    location.href = '/lobby.html';

  } catch (e) { show('Сбой сети: ' + e.message); }
}

/* лаконичный вывод */
function show(txt){ document.getElementById('msg').textContent = txt; }
</script>
</body>
</html>
