<!-- 1. официальный скрипт VK ID One-Tap -->
<script src="https://vk.com/js/sdk.js?vkid=1" defer></script>

<!-- …ваша остальная разметка… -->

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ждём, пока sdk.js создаст глобальный объект VKID */
  const waitSDK = new Promise(r => {
    if (window.VKIDSDK) return r();
    window.addEventListener('VKIDSDKReady', r, { once:true });
  });

  waitSDK.then(() => {
    const VKID = window.VKIDSDK;
    const API  = 'https://vercel2pr.onrender.com';

    VKID.Config.init({ app: 54008517, source: VKID.ConfigSource.ONE_TAP });

    /* ⚠️ БЕЗ new с версией sdk.js */
    VKID.OneTap({
      container: document.getElementById('vk_container'),
      scheme: 'dark',
      showAlternativeLogin: true,
      oauthList: ['mail_ru']
    })
    .then(widget => {
      widget.on(VKID.WidgetEvents.ERROR, showError);
      widget.on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, sendCode);
    });

    async function sendCode({ code, device_id, code_verifier }) {
      const resp = await fetch(`${API}/api/auth/vk-callback`, {
        method : 'POST',
        headers: { 'Content-Type':'application/json' },
        body   : JSON.stringify({
          code,
          deviceId    : device_id,
          codeVerifier: code_verifier
        })
      });
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({}));
        return showError({ text: err.error_description || err.error });
      }
      const { token } = await resp.json();
      localStorage.setItem('authToken', token);
      location.href = '/lobby.html';
    }

    function showError(e) {
      document.getElementById('login-message').textContent =
        e?.text || 'Ошибка авторизации, попробуйте ещё раз';
    }
  });
});
</script>
