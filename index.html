<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Вход через VK ID</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://unpkg.com/@vkid/sdk@2.6.0/dist-sdk/umd/index.js"></script>

  <link href="https://fonts.googleapis.com/css?family=Inter:700,400&display=swap" rel="stylesheet">
  <style>/* стили «коробки» оставлены без изменений */</style>
</head>
<body>
  <div class="wrap">
    <div class="box">
      <h1>Вход через VK</h1>
      <div id="vk_container"></div>
      <div id="msg">Нажмите <b>«Войти с VK ID»</b>, затем подтвердите вход</div>
    </div>
  </div>

<script>
const API      = 'https://vercel2pr.onrender.com';
const APP_ID   = 54008517;
const REDIRECT = 'https://sweet-twilight-63a9b6.netlify.app/vk-callback.html';

document.addEventListener('DOMContentLoaded', () => {
  const VKID = window.VKIDSDK;

  VKID.Config.init({
    app: APP_ID,
    redirectUrl: REDIRECT,
    source: VKID.ConfigSource.ONE_TAP
  });

  new VKID.OneTap().render({
    container: document.getElementById('vk_container'),
    scheme: 'dark',
    showAlternativeLogin: false,
    buttonStyles:{height:44,borderRadius:12,
      backgroundColor:'#0054ff',hoverColor:'#0e63ff',
      activeColor:'#0048db',textColor:'#ffffff'}
  })
  .on(VKID.WidgetEvents.ERROR,  e=>show(e.text))
  /* ← единственный обмен */
  .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, sendCode);
});

async function sendCode({ code, device_id, code_verifier }) {
  try {
    const r = await fetch(`${API}/api/auth/vk-callback`, {
      method :'POST',
      headers:{'Content-Type':'application/json'},
      body   :JSON.stringify({ code,
                               deviceId    : device_id,
                               codeVerifier: code_verifier })
    });
    if(!r.ok){
      const e = await r.json().catch(()=>({}));
      return show(e.error_description||e.error||'fail');
    }
    const { token } = await r.json();
    localStorage.setItem('authToken', token);
    location.href = '/lobby.html';
  } catch(e){ show(e.message); }
}
function show(t){ document.getElementById('msg').textContent = 'Ошибка: '+t; }
</script>
</body>
</html>
