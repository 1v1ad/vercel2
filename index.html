<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GG Room</title>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%230b0d12'/%3E%3Ctext x='50%25' y='54%25' text-anchor='middle' font-size='34' fill='%23f4d88a' font-family='Arial'%3EG%3C/text%3E%3C/svg%3E">

  <style>
    :root{
      --bg:#0b0d12; --card:#000; --text:#e8eaf0; --muted:#98a2b3; --gold:#f4d88a;
      --radius:18px; --border:rgba(255,255,255,.06);
      --vk:#2787F5;

      /* Базовый размер нативной TG-кнопки (size=large) */
      --btnw: 300px;
      --btnh: 52px;

      /* «Чуть больше» */
      --scale: 1.06;
    }

    @media (max-width: 360px){
      :root{ --scale: 0.96; } /* чтобы влезало на узких мобилках */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:radial-gradient(1200px 600px at 50% -10%, #171b24 0%, #0b0d12 55%, #090b10 100%);
      display:flex; flex-direction:column;
    }
    header{display:flex; justify-content:center; padding:14px 16px; border-bottom:1px solid var(--border)}
    header b{color:var(--gold); letter-spacing:.4px}

    .wrap{flex:1; display:grid; place-items:center; padding:40px 16px}

    .card{
      width:min(520px,100%); background:#000; position:relative; overflow:hidden;
      border-radius:var(--radius); padding:28px 24px; border:1px solid rgba(247,228,164,.35);
      box-shadow:0 10px 40px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.02);
    }
    .card::before{
      content:""; position:absolute; inset:0; border-radius:inherit;
      --w:1px; padding:var(--w);
      background:linear-gradient(135deg, rgba(247,228,164,.8), rgba(247,228,164,.35) 45%, rgba(247,228,164,.6));
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none;
    }

    h1{
      margin:0 0 10px; font-size:26px; line-height:1.2; font-weight:800;
      color:var(--gold); text-align:center; white-space:nowrap;
    }

    /* Общая панель кнопок — центрируем и даём одинаковую ширину */
    .btnbar{
      display:flex; flex-direction:column; align-items:center; gap:12px;
      margin-bottom:4px;
    }
    .btn-like{
      width: calc(var(--btnw) * var(--scale));
      height: calc(var(--btnh) * var(--scale));
      border-radius:12px; display:flex; align-items:center; justify-content:center;
      font-weight:800; font-size:16px; line-height:1; white-space:nowrap;
      box-shadow:0 8px 24px rgba(39,135,245,.25);
      user-select:none; -webkit-tap-highlight-color:transparent;
    }

    /* VK-кнопка — стили «как у TG»: с иконкой слева и тем же размером */
    .vk-like{
      background: var(--vk); color:#fff; border:0; cursor:pointer;
      gap:10px; padding:0 18px;
    }
    .vk-like svg{ width:22px; height:22px; fill:#fff; flex:0 0 auto }

    /* Telegram — НЕТ фона. Центрируем только iframe и слегка скейлим */
    .tg-wrap{
      position:relative;
      width: calc(var(--btnw) * var(--scale));
      height: calc(var(--btnh) * var(--scale));
      display:flex; align-items:center; justify-content:center;
      line-height:0;
    }
    .tg-wrap iframe{
      transform: scale(var(--scale));
      transform-origin: center center;
      width: var(--btnw) !important;
      height: var(--btnh) !important;
      border:0 !important; display:block; margin:0 !important; background:transparent !important;
      pointer-events:auto !important;
    }

    .status{margin-top:10px; color:var(--muted); min-height:1.2em}

    .badges{margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:nowrap}
    .badge{border:1px solid rgba(247,228,164,.35); color:var(--gold); background:rgba(247,228,164,.06);
      padding:6px 10px; border-radius:999px; font-size:12px; white-space:nowrap}

    .card-media{ margin:16px -24px -28px; border-bottom-left-radius:var(--radius); border-bottom-right-radius:var(--radius); overflow:hidden }
    .card-media picture, .card-media img{ display:block; width:100%; height:auto }

    @media (max-width:480px){
      h1{font-size:18px}
      .badges{gap:6px}
      .badge{font-size:11px; padding:6px 8px}
      .card-media{ margin:14px -16px -24px }
    }

    /* статус-лоадер для TG ожидания */
    .loader{display:inline-flex; gap:6px; align-items:center; margin-left:8px}
    .loader .dot{width:6px; height:6px; border-radius:50%; background:#98a2b3; opacity:.3; animation:blink 1.2s infinite ease-in-out}
    .loader .dot:nth-child(2){animation-delay:.2s}.loader .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.3}40%{opacity:1}}
  </style>
</head>
<body>
  <header><b>GG ROOM</b></header>

  <main class="wrap">
    <section class="card">
      <h1>Войдите и начните выигрывать!</h1>

      <div class="btnbar">
        <!-- VK в том же размере и с иконкой -->
        <button class="btn-like vk-like" id="login" type="button" aria-label="Войти через VK ID">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M13.3 18c-.5 0-.7-.3-1.2-.8-.9-.9-1.3-1-1.5-1-.3 0-.3.1-.3.5v1.1c0 .4-.1.5-.9.5-1.3 0-2.8-.8-4.1-2.3C2.3 13.2 1 10.9 1 9.2c0-.4.1-.5.6-.5h1.9c.5 0 .6.2.7.6.8 2.1 2.3 4.1 3 4.1.2 0 .2-.2.2-.6V9c0-.5-.1-.7-.6-.7H5.9c-.4 0-.5-.2-.5-.6V6.1c0-.4.2-.6.6-.6h3c.5 0 .6.2.7.6v3.9c0 .3.1.5.2.5.2 0 .5-.3 1-1 1-1.4 1.7-3 1.7-3.4 0-.3.2-.5.6-.5h2.1c.5 0 .6.2.6.5 0 .5-1.1 2.6-2.2 4.1-.3.4-.4.6 0 .9.7.5 1.5 1.4 2.3 2.4 1.1 1.4 1.4 2.1 1.4 2.4 0 .4-.2.6-.7.6h-2c-.5 0-.7-.2-1-.6-.8-1.2-1.7-2.2-2-2.2-.2 0-.2.1-.2.5v1.1c0 .4-.1.6-.6.6h-1.2z"/>
          </svg>
          Войти через VK ID
        </button>

        <!-- Telegram: только виджет, без фона -->
        <div class="tg-wrap" id="tg-login">
          <script async src="https://telegram.org/js/telegram-widget.js?22"
                  data-telegram-login="GGR00m_bot"
                  data-size="large"
                  data-userpic="false"
                  data-request-access="write"
                  data-onauth="onTelegramAuth(user)">
          </script>
        </div>
      </div>

      <p class="status" id="status"></p>

      <div class="badges">
        <div class="badge">Розыгрыши</div>
        <div class="badge">Гарантии призов</div>
        <div class="badge">Турниры 24/7</div>
      </div>

      <div class="card-media">
        <picture>
          <source type="image/webp"
            srcset="assets/prize-chest-500w.webp 500w,
                    assets/prize-chest-700w.webp 700w,
                    assets/prize-chest-900w.webp 900w"
            sizes="(max-width: 480px) 100vw, 640px">
          <source type="image/png"
            srcset="assets/prize-chest-500w.png 500w,
                    assets/prize-chest-700w.png 700w,
                    assets/prize-chest-900w.png 900w"
            sizes="(max-width: 480px) 100vw, 640px">
          <img src="assets/prize-chest-700w.png" alt="Призовой сундук" loading="lazy" decoding="async">
        </picture>
      </div>
    </section>
  </main>

  <script>
    const API = 'https://vercel2pr.onrender.com';

    // лёгкий прогрев Render (чтобы меньше ждать)
    function warmUpBackend(){
      try{ new Image().src = API + '/?wake=' + Date.now(); }catch(_){}
      try{ fetch(API + '/__wake', { mode: 'no-cors', cache: 'no-store' }).catch(()=>{}); }catch(_){}
    }
    window.addEventListener('load', warmUpBackend);
    document.getElementById('login')?.addEventListener('mouseenter', warmUpBackend);
    document.getElementById('tg-login')?.addEventListener('mouseenter', warmUpBackend);

    // VK → редирект (у VK показывается «Render waking up…» — это норм)
    document.getElementById('login').onclick = () => {
      warmUpBackend();
      window.location.href = API + '/api/auth/vk/start';
    };

    // TG → показываем понятный статус, если Render спит (ретраи)
    const $s = () => document.getElementById('status');
    function setStatus(text, wait=false){
      $s().innerHTML = wait
        ? `${text}<span class="loader"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`
        : text;
    }
    async function postWithRetries(url, body, { attempts=6, timeoutMs=10000 } = {}){
      let delay = 700;
      for (let i=0;i<attempts;i++){
        warmUpBackend();
        try{
          const ctrl = new AbortController();
          const t = setTimeout(()=>ctrl.abort(), timeoutMs);
          const r = await fetch(url, {
            method:'POST', headers:{'Content-Type':'application/json'},
            credentials:'include', body:JSON.stringify(body), signal:ctrl.signal
          });
          clearTimeout(t);
          if (r.ok) return await r.json();
        }catch(_){}
        await new Promise(r=>setTimeout(r, delay));
        delay = Math.min(Math.round(delay*1.7), 6000);
      }
      throw new Error('timeout');
    }

    async function onTelegramAuth(user){
      try{
        setStatus('Подключаем сервер… это может занять до 30 секунд', true);
        const data = await postWithRetries(API + '/api/auth/tg', { user });

        if (!data.ok){ setStatus('TG вход: ' + (data.error||'ошибка')); return; }

        if (data.mergeNeeded && data.primary && data.merged){
          setStatus('Найден второй профиль. Готовим объединение…');
          const ok = confirm(
            `Найден второй профиль.\n`+
            `Primary(ID ${data.primary.id}) баланс=${data.primary.balance} ₽\n`+
            `Merged (ID ${data.merged.id}) баланс=${data.merged.balance} ₽\n`+
            `Объединить и перенести баланс/историю?`
          );
          if (ok){
            const j2 = await postWithRetries(API + '/api/link/merge/confirm',
                { primaryId:data.primary.id, mergedId:data.merged.id }, { attempts:4, timeoutMs:10000 });
            setStatus(j2.ok ? 'Аккаунты объединены' : ('Не удалось объединить: ' + (j2.error||'')));
            if (j2.ok) setTimeout(()=>location.href='lobby.html', 600);
          } else {
            setStatus('Объединение отменено');
          }
          return;
        }

        if (data.token) localStorage.setItem('session', data.token);
        setStatus('TG авторизация успешна');
        setTimeout(()=>location.href='lobby.html', 600);

      }catch(e){
        console.error(e);
        setStatus('TG вход: сервер не ответил. Попробуйте ещё раз.');
      }
    }

    // возврат после VK (?logged=1)
    (function handleLoggedRedirect(){
      const p = new URLSearchParams(location.search);
      if (p.get('logged') === '1') {
        setStatus('Готово: авторизован. Переходим в лобби…', true);
        setTimeout(()=>location.href='lobby.html', 500);
      }
    })();
  </script>
</body>
</html>
