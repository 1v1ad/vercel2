<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Вход через VK ID</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- VK ID SDK -->
 <script>
const API     = 'https://vercel2pr.onrender.com';
const APP_ID  = 54008517;
const REDIRECT = 'https://sweet-twilight-63a9b6.netlify.app/';   // ← 1️⃣

document.addEventListener('DOMContentLoaded', () => {
  const VKID = window.VKIDSDK;

  /* redirectUrl ОБЯЗАТЕЛЕН */
  VKID.Config.init({
    app: APP_ID,
    redirectUrl: REDIRECT,                // ← 2️⃣
    source: VKID.ConfigSource.ONE_TAP
  });

  new VKID.OneTap().render({
    container: document.getElementById('vk_container'),
    scheme: 'dark',
    showAlternativeLogin: false,
    buttonStyles:{
      height:44,borderRadius:12,
      backgroundColor:'#0054ff',
      hoverColor:'#0e63ff',
      activeColor:'#0048db',
      textColor:'#ffffff'
    }
  })
  .on(VKID.WidgetEvents.ERROR,          showError)
  .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, sendCode);
});

async function sendCode({ code, device_id, code_verifier }) {
  try {
    const r = await fetch(`${API}/api/auth/vk-callback`, {
      method :'POST',
      headers:{'Content-Type':'application/json'},
      body   :JSON.stringify({ code, deviceId: device_id, codeVerifier: code_verifier })
    });
    if (!r.ok) {
      const e = await r.json().catch(()=>({}));
      return showError({text:e.error_description||e.error});
    }
    const { token } = await r.json();
    localStorage.setItem('authToken', token);
    location.href = '/lobby.html';
  } catch(e){ showError({text:e.message}); }
}
function showError(e){
  document.getElementById('msg').textContent =
    e?.text || 'Ошибка авторизации. Попробуйте снова.';
}
</script>

/* ===== НАСТРОЙКИ ===== */
const API    = 'https://vercel2pr.onrender.com';   // ваш бек
const APP_ID = 54008517;                           // id приложения VK

document.addEventListener('DOMContentLoaded', () => {
  const VKID = window.VKIDSDK;

  /* 1. инициализируем SDK — redirect / responseMode НЕ нужны */
  VKID.Config.init({
    app:    APP_ID,
    source: VKID.ConfigSource.ONE_TAP
  });

  /* 2. рисуем тёмную кнопку One-Tap */
  new VKID.OneTap().render({
    container: document.getElementById('vk_container'),
    scheme: 'dark',
    showAlternativeLogin: false,
    buttonStyles:{
      height:44,borderRadius:12,
      backgroundColor:'#0054ff',
      hoverColor:'#0e63ff',
      activeColor:'#0048db',
      textColor:'#ffffff'
    }
  })
  .on(VKID.WidgetEvents.ERROR,          showError)
  .on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, sendCode);
});

/* 3. отправляем code (+ device_id, verifier) — ровно ОДИН запрос */
async function sendCode({ code, device_id, code_verifier }) {
  try {
    const r = await fetch(`${API}/api/auth/vk-callback`, {
      method :'POST',
      headers:{'Content-Type':'application/json'},
      body   :JSON.stringify({ code, deviceId: device_id, codeVerifier: code_verifier })
    });

    if (!r.ok) {
      const e = await r.json().catch(()=>({}));
      return showError({ text: e.error_description || e.error || 'fail' });
    }

    const { token } = await r.json();
    localStorage.setItem('authToken', token);
    location.href = '/lobby.html';
  } catch (e) { showError({ text: e.message }); }
}

/* компактный вывод ошибок */
function showError(e){
  document.getElementById('msg').innerHTML =
    (e?.text || 'Ошибка авторизации. Попробуйте снова.');
}
</script>
</body>
</html>

