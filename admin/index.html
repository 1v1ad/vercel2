<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GGRoom — Admin</title>

  <!-- Стили (оставь свои пути, если отличаются) -->
  <link rel="icon" href="favicon.ico" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="styles.patch.css" />
  <!-- emojis.css удалён: флаги теперь рисует flags.js -->

  <style>
    /* лёгкие дефолты на случай, если нет своих стилей */
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif; background:#0b0f14; color:#d7dee9; }
    .wrap { max-width:1200px; margin:0 auto; padding:16px; }
    .toolbar { display:flex; gap:8px; align-items:center; }
    .toolbar input[type="text"], .toolbar input[type="password"] { background:#111923; color:#d7dee9; border:1px solid #1f2a36; border-radius:8px; padding:10px 12px; width:340px; }
    .toolbar button { background:#1e293b; color:#e5f0ff; border:1px solid #2a3a4f; border-radius:8px; padding:10px 14px; cursor:pointer; }
    .grid { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin:16px 0; }
    .card { background:#111923; border:1px solid #1f2a36; border-radius:12px; padding:16px; min-height:92px; }
    .card h3 { margin:0 0 8px 0; font-weight:600; color:#9fb4d9; font-size:14px; letter-spacing:.02em; }
    .num { font-size:28px; font-weight:700; }
    .panel { background:#0e141d; border:1px solid #1c2735; border-radius:12px; margin:16px 0; overflow:hidden; }
    .panel-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #1c2735; background:#0b111a; }
    .panel-header h4 { margin:0; font-size:15px; color:#9fb4d9; }
    .panel-body { padding:16px; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:9px 8px; border-bottom:1px solid #182432; }
    th { color:#8fa4c6; font-weight:600; font-size:13px; }
    td { color:#d7dee9; font-size:14px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .muted { color:#8fa4c6; opacity:.8; font-size:12px; }
    .right { text-align:right; }
    .badge { display:inline-block; background:#182432; border:1px solid #25405b; color:#a5c4f1; border-radius:999px; padding:2px 8px; font-size:12px; }
/* ⬇️ фикс превращения флага в "de" */
[data-cc] {
  text-transform: none !important;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, "Noto Sans",
               "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
}
    /* защита от text-transform у предков */
[data-cc] { text-transform: none !important; }
.flag-emoji, .cc { text-transform: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <input id="admin-api" type="text" placeholder="https://vercel2pr.onrender.com" />
      <input id="admin-pwd" type="password" placeholder="Пароль администратора" />
      <button id="admin-save">Сохранить</button>
      <button id="admin-check">Проверка</button>
      <span class="muted">API и пароль сохраняются в localStorage</span>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Пользователи</h3>
        <div id="summary-users" class="num">—</div>
      </div>
      <div class="card">
        <h3>События</h3>
        <div id="summary-events" class="num">—</div>
      </div>
      <div class="card">
        <h3>Авторизаций (7д)</h3>
        <div id="summary-auth" class="num">—</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Уникальные (7д)</h3>
        <div id="summary-unique" class="num">—</div>
      </div>
      <div class="card">
        <h3>Склейка: предложения</h3>
        <div class="actions">
          <button id="merge-suggest-run">Склеить все</button>
          <span class="muted">Укажи API и пароль сверху</span>
        </div>
      </div>
      <div class="card">
        <h3>Пополнение</h3>
        <div class="actions">
          <input id="topup-user-id" type="text" placeholder="user_id" style="width:120px" />
          <input id="topup-amount"  type="text" placeholder="сумма" style="width:120px" />
          <button id="topup-run">Пополнить вручную</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <h4>Аналитика посещений</h4>
        <div class="badge">7 дней</div>
      </div>
      <div class="panel-body">
        <svg id="chart" width="100%" height="300"></svg>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <h4>Пользователи</h4>
        <div class="actions">
          <input id="users-search" type="text" placeholder="Поиск (vk_id, имя, фамилия)" />
          <button id="users-refresh">Обновить</button>
        </div>
      </div>
      <div class="panel-body">
        <table>
          <thead>
            <tr>
              <th>HUMid</th>
              <th>user_id</th>
              <th>VK/Tg</th>
              <th>Имя</th>
              <th>Фамилия</th>
              <th class="right">Баланс</th>
              <th>Страна</th>
              <th>Создан</th>
              <th>Провайдеры</th> <!-- ← можно убрать, если не требуется -->
            </tr>
          </thead>
          <tbody id="users-tbody">
            <!-- наполняется скриптом -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <h4>События</h4>
        <div class="actions">
          <input id="events-type" type="text" placeholder="Тип (login, auth_…)" />
          <input id="events-user" type="text" placeholder="user_id" style="width:120px" />
          <button id="events-refresh">Обновить</button>
        </div>
      </div>
      <div class="panel-body">
        <table>
          <thead>
            <tr>
              <th>ID события</th>
              <th>HUMid</th>
              <th>user_id</th>
              <th>event_type</th>
              <th>type</th>
              <th>IP</th>
              <th>UA</th>
              <th>Создано</th>
            </tr>
          </thead>
          <tbody id="events-tbody">
            <!-- наполняется скриптом -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ВАЖНО: ШИМ ДОЛЖЕН ИДТИ ПЕРВЫМ, чтобы подставлять X-Admin-Password -->
  <script src="admin-auth-headers.js?v=20251007d"></script>

  <!-- flags.js подключаем до app.js, чтобы была доступна decorateFlags -->
  <script src="flags.js"></script>
 
  <!-- основной код админки -->
  <script src="app.js?v=20251007d"></script>
  <script src="merge-suggest.js"></script>
  <script src="topup.js"></script>
  <script src="chart.js?v=20251007d"></script>

  <!-- Glue-код страницы: хранение API/пароля, действия, запросы -->
  <script>
// Timezone helper: render UTC-ish ISO as Europe/Moscow (YYYY-MM-DD HH:mm:ss)
function toMSK(iso){
  if(!iso) return '';
  try{
    const s = String(iso);
    const d = new Date(s.endsWith('Z') ? s : (s + 'Z')); // treat as UTC
    const p = new Intl.DateTimeFormat('sv-SE', {
      timeZone: 'Europe/Moscow', hour12: false,
      year:'numeric', month:'2-digit', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit'
    }).formatToParts(d).reduce((o,part)=> (o[part.type]=part.value,o),{});
    return `${p.year}-${p.month}-${p.day} ${p.hour}:${p.minute}:${p.second}`;
  }catch(e){
    return String(iso).slice(0,19).replace('T',' ');
  }
}

    (function(){
      // загрузка/сохранение API/пароля в UI
      const apiEl = document.getElementById('admin-api');
      const pwdEl = document.getElementById('admin-pwd');
      const saveBtn = document.getElementById('admin-save');
      const checkBtn = document.getElementById('admin-check');

      apiEl.value = localStorage.getItem('ADMIN_API') || (window.API || '');
      pwdEl.value = localStorage.getItem('ADMIN_PWD') || '';

      saveBtn.addEventListener('click', () => {
        localStorage.setItem('ADMIN_API', apiEl.value.trim());
        localStorage.setItem('ADMIN_PWD', pwdEl.value);
        alert('OK');
      });

      checkBtn.addEventListener('click', async () => {
        const API = (localStorage.getItem('ADMIN_API') || '').replace(/\/+$/,'');
        if (!API) return alert('Укажи API');
        const r = await fetch(API + '/api/admin/health', { headers: window.adminHeaders ? window.adminHeaders() : {} });
        const j = await r.json().catch(()=>({}));
        alert(j && j.ok ? 'OK' : 'Ошибка');
      });

      // Helpers для перерисовки карточек summary
      function setText(id, v){ const el = document.getElementById(id); if (el) el.textContent = v; }

      async function refreshSummary(){
        const API = (localStorage.getItem('ADMIN_API') || '').replace(/\/+$/,'');
        if (!API) return;
        const r = await fetch(API + '/api/admin/summary', { headers: window.adminHeaders ? window.adminHeaders() : {}, cache:'no-store' });
        const j = await r.json().catch(()=>({}));
        if (!j || !j.ok) return;
        setText('summary-users',  j.users ?? '—');
        setText('summary-events', j.events ?? '—');
        setText('summary-auth',   j.auth7 ?? '—');
        setText('summary-unique', j.unique7 ?? '—');
      }

      // Users
      async function refreshUsers(){
        const API = (localStorage.getItem('ADMIN_API') || '').replace(/\/+$/,'');
        if (!API) return;
        const q = new URLSearchParams({ take:'25', skip:'0', search:(document.getElementById('users-search')?.value || '').trim() });
        const r = await fetch(API + '/api/admin/users?' + q.toString(), { headers: window.adminHeaders ? window.adminHeaders() : {}, cache:'no-store' });
        const j = await r.json().catch(()=>({}));
        const rows = Array.isArray(j.users) ? j.users : [];
        const tbody = document.getElementById('users-tbody');
        if (!tbody) return;
        tbody.innerHTML = rows.map(u => `
          <tr>
            <td>${u.id ?? ''}</td>
            <td>${u.vk_id ?? ''}</td>
            <td>${u.first_name ?? ''}</td>
            <td>${u.last_name ?? ''}</td>
            <td class="right">${u.balance ?? 0}</td>
            <td data-cc="${(u.country_code || '').toUpperCase()}"></td>
            <td>${toMSK(u.created_at)}</td>
            <td>${Array.isArray(u.providers) ? u.providers.join(', ') : ''}</td> <!-- ← можно убрать, если не требуется -->
          </tr>
        `).join('');

        // ДОрисуем флаги для только что вставленных строк
        if (window.decorateFlags) window.decorateFlags(tbody);
      }

      // Events
      async function refreshEvents(){
        const API = (localStorage.getItem('ADMIN_API') || '').replace(/\/+$/,'');
        if (!API) return;
        const qs = new URLSearchParams({
          take:'50', skip:'0',
          event_type:(document.getElementById('events-type')?.value || '').trim(),
          user_id: (document.getElementById('events-user')?.value || '').trim()
        });
        const r = await fetch(API + '/api/admin/events?' + qs.toString(), { headers: window.adminHeaders ? window.adminHeaders() : {}, cache:'no-store' });
        const j = await r.json().catch(()=>({}));
        const rows = Array.isArray(j.events) ? j.events : [];
        const tbody = document.getElementById('events-tbody');
        if (!tbody) return;
        tbody.innerHTML = rows.map(e => `
          <tr>
            <td>${e.id ?? ''}</td>
            <td>${e.user_id ?? ''}</td>
            <td>${e.event_type ?? ''}</td>
            <td>${e.type ?? ''}</td>
            <td>${e.ip ?? ''}</td>
            <td class="muted">${(e.ua || '').slice(0,64)}</td>
            <td>${toMSK(e.created_at)}</td>
          </tr>
        `).join('');
      }

      // Wire UI
      document.getElementById('users-refresh')?.addEventListener('click', refreshUsers);
      document.getElementById('events-refresh')?.addEventListener('click', refreshEvents);
      document.getElementById('merge-suggest-run')?.addEventListener('click', async () => {
        const API = (localStorage.getItem('ADMIN_API') || '').replace(/\/+$/,'');
        if (!API) return;
        // просто дергаем предложения — фактическая автосклейка уже в фоне
        await fetch(API + '/api/admin/users/merge/suggestions', { headers: window.adminHeaders ? window.adminHeaders() : {}, cache:'no-store' })
          .then(r=>r.json()).catch(()=>({}));
        alert('OK');
      });

      document.getElementById('topup-run')?.addEventListener('click', async () => {
        const id = document.getElementById('topup-user-id')?.value.trim();
        const amount = document.getElementById('topup-amount')?.value.trim();
        const API = (localStorage.getItem('ADMIN_API') || '').replace(/\/+$/,'');
        if (!API || !id) return;
        const r = await fetch(API + '/api/admin/users/' + id + '/topup', {
          method:'POST',
          headers: Object.assign({'Content-Type':'application/json'}, (window.adminHeaders?window.adminHeaders():{})),
          body: JSON.stringify({ amount: Number(amount)||0 })
        });
        const j = await r.json().catch(()=>({}));
        alert(j && j.ok ? 'OK' : 'Ошибка');
        refreshUsers();
      });

      // Автозагрузка при входе
      refreshSummary();
      refreshUsers();
      refreshEvents();
    })();
  </script>
</body>
</html>
