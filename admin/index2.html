<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GGRoom — Admin v2</title>

  <link rel="icon" type="image/svg+xml"
        href='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="%231a73e8"/><stop offset="1" stop-color="%234ed1a9"/></linearGradient></defs><rect rx="12" width="64" height="64" fill="%23f5f7fa"/><path d="M14 44l8-24h6l8 24h-6l-1.6-5H21.6L20 44h-6z" fill="url(%23g)"/></svg>' />
  <link rel="stylesheet" href="/admin/admin2.css?v=20251225j" />
  <script defer src="/admin/flags.js?v=20251225g"></script>
</head>

<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">GG</div>
        <div class="brand-text">
          <div class="brand-title">GGRoom</div>
          <div class="brand-sub">Admin v2</div>
        </div>
      </div>

      <nav class="nav">
        <a class="nav-item active" href="#summary" data-view="summary">
          <svg class="nav-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="3" y="3" width="18" height="18" rx="4" />
            <path d="M7 17v-5" />
            <path d="M12 17V7" />
            <path d="M17 17v-8" />
          </svg>
          <span>Summary</span>
        </a>
        <a class="nav-item" href="#finance" data-view="finance">
          <svg class="nav-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="3" y="6" width="18" height="12" rx="3" />
            <path d="M3 10h18" />
            <path d="M7 14h4" />
            <path d="M16.5 14h.01" />
          </svg>
          <span>Финансы</span>
        </a>
        <a class="nav-item" href="#users" data-view="users">
          <svg class="nav-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="9" cy="9" r="3" />
            <path d="M3.5 20a6.5 6.5 0 0 1 11 0" />
            <circle cx="17" cy="10" r="2" />
            <path d="M14.5 20a5.5 5.5 0 0 1 6 0" />
          </svg>
          <span>Пользователи</span>
        </a>

        <div class="nav-sub" data-parent="users">
          <a class="nav-sub-item" href="#users/list" data-view="users" data-users-sub="list"><span>Список</span></a>
          <a class="nav-sub-item" href="#users/analytics" data-view="users" data-users-sub="analytics"><span>Аналитика</span></a>
        </div>
        <a class="nav-item" href="#duels" data-view="duels">
          <svg class="nav-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M5 4l6 6" />
            <path d="M9 2l2 2-3 3-2-2z" />
            <path d="M3 20l5-5" />
            <path d="M19 4l-6 6" />
            <path d="M15 2l-2 2 3 3 2-2z" />
            <path d="M21 20l-5-5" />
          </svg>
          <span>Дуэли</span>
        </a>
        <a class="nav-item" href="#events" data-view="events">
          <svg class="nav-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M7 3h7l3 3v15a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3z" />
            <path d="M14 3v4a2 2 0 0 0 2 2h4" />
            <path d="M7 13h10" />
            <path d="M7 17h10" />
          </svg>
          <span>События</span>
        </a>

        <div class="nav-sep"></div>

        <a class="nav-item" href="#topup" data-view="topup">
          <svg class="nav-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="3" y="3" width="18" height="18" rx="4" />
            <path d="M12 8v8" />
            <path d="M8 12h8" />
          </svg>
          <span>Ручное пополнение</span>
        </a>
        <a class="nav-item" href="#unmerge" data-view="unmerge">
          <svg class="nav-ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M8 8h-1a4 4 0 0 0 0 8h1" />
            <path d="M16 8h1a4 4 0 0 1 0 8h-1" />
            <path d="M10 12h1" />
            <path d="M13 12h1" />
            <path d="M8 16l8-8" />
          </svg>
          <span>Расклейка</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <a class="muted-link" href="/admin/index.html">Классическая админка →</a>
        <div class="muted tiny">Style: Keenetic-ish</div>
      </div>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topbar-left">
          <div class="page-title" id="page-title">Summary</div>
          <label class="hum-switch" title="HUM-склейка">
            <span class="hum-label">HUM-склейка</span>
            <input id="admin-hum-flag" type="checkbox" />
            <span class="hum-track" aria-hidden="true">
              <span class="hum-state hum-on">ON</span>
              <span class="hum-state hum-off">OFF</span>
              <span class="hum-thumb"></span>
            </span>
            <span id="admin-hum-note" class="tiny muted"></span>
          </label>
        </div>

        <div class="topbar-right">
          <input id="api" class="input" placeholder="https://... (ADMIN_API)" />
          <input id="pwd" class="input" placeholder="ADMIN_PWD" type="password" />
          <button class="btn" id="save">Сохранить</button>
          <button class="btn ghost" id="ping">Проверка</button>
        </div>
      </header>

      <div class="content">

        <section class="view active" id="view-summary">
          <div class="grid cards">
            <div class="card users-card">
              <div class="card-main">
                <div class="card-title">Пользователи</div>
                <div class="card-value" id="sum-users">—</div>
                <div class="card-sub muted tiny" id="sum-users-sub">всего / новые today</div>
              </div>
              <div class="card-spark" title="Динамика пользователей за последние 90 дней (всего + новые)">
                <div id="users-mini-tip" class="spark-tip" aria-hidden="true"></div>
                <svg id="users-mini-chart" class="spark-svg" aria-label="Users 90d sparkline"></svg>
                <div class="spark-legend muted tiny">
                  <span class="dot dot-total"></span><span>всего</span>
                  <span class="dot dot-new"></span><span>новые</span>
                </div>
              </div>
            </div>
            <div class="card events-card">
              <div class="card-main">
                <div class="card-title">События</div>
                <div class="card-value" id="sum-events">—</div>
                <div class="card-sub muted tiny" id="sum-events-sub">всего / сегодня</div>
              </div>
              <div class="card-spark" title="Динамика событий за последние 90 дней (всего + за день)">
                <div id="events-mini-tip" class="spark-tip" aria-hidden="true"></div>
                <svg id="events-mini-chart" class="spark-svg" aria-label="Events 90d sparkline"></svg>
                <div class="spark-legend muted tiny">
                  <span class="dot dot-total"></span><span>всего</span>
                  <span class="dot dot-new"></span><span>за день</span>
                </div>
              </div>
            </div>
                        <div class="card card-metrics">
              <div class="card-title">Занесено / выведено</div>
              <div class="card-value">
                <span id="sum-deposited-all">—</span> / <span id="sum-deposited-today">—</span>
              </div>
              <div class="card-sub muted tiny">занесено всего / сегодня</div>
              <div class="card-sub muted tiny secondary">
                выведено: <span id="sum-withdrawn-all">—</span> / <span id="sum-withdrawn-today">—</span>
              </div>
            </div>
            <div class="card liabilities-card">
              <div class="card-main">
                <div class="card-title">На балансах</div>
                <div class="card-value" id="sum-liabilities">—</div>
                <div class="card-sub muted tiny">сумма на балансах пользователей</div>
              </div>
              <div class="card-spark" title="Сумма на балансах пользователей за последние 90 дней">
                <div id="liab-mini-tip" class="spark-tip" aria-hidden="true"></div>
                <svg id="liab-mini-chart" class="spark-svg" aria-label="Liabilities 90d bars"></svg>
                <div class="spark-legend muted tiny">
                  <span class="dot dot-new"></span><span>на балансах</span>
                </div>
              </div>
            </div>
                        <div class="card card-metrics">
              <div class="card-title">Дуэли: оборот / рейк</div>
              <div class="card-value">
                <span id="sum-turnover-all">—</span> / <span id="sum-turnover-today">—</span>
              </div>
              <div class="card-sub muted tiny">оборот всего / сегодня</div>
              <div class="card-sub muted tiny secondary">
                рейк: <span id="sum-rake-all" class="num-rake">—</span> / <span id="sum-rake-today" class="num-rake">—</span>
              </div>
            </div>
            <div class="card">
              <div class="card-title">Статус</div>
              <div class="kv">
                <div class="k">API</div><div class="v" id="stat-api">—</div>
                <div class="k">Admin</div><div class="v" id="stat-admin">—</div>
              </div>
            </div>
          </div>

          <div class="grid two summary-charts">
            <div class="panel">
              <div class="panel-head">
                <div class="panel-title">Аналитика по диапазону</div>
                <div class="panel-actions">
                  <span class="muted tiny">c</span>
                  <input class="input input-date" id="range-from" type="date" />
                  <span class="muted tiny">по</span>
                  <input class="input input-date" id="range-to" type="date" />
                  <button class="chip" data-preset="7">7д</button>
                  <button class="chip" data-preset="30">30д</button>
                  <button class="chip" data-preset="90">90д</button>
                  <button class="chip" data-preset="365">Год</button>
                  <button class="chip" data-preset="all">Всё</button>
                  <button class="btn sm" id="range-apply">Показать</button>
                </div>
              </div>
              <div class="chart-wrap">
                <svg id="chart-range" width="100%" height="260" aria-label="Range chart"></svg>
                <div class="muted tiny" id="range-note" style="margin-top:6px;"></div>
              </div>
            </div>

            <div class="panel">
              <div class="panel-head">
                <div class="panel-title">Аналитика посещений</div>
                <span class="chip">7 дней</span>
              </div>
              <div class="chart-wrap">
                <svg id="chart" width="100%" height="260" aria-label="Visits chart"></svg>
              </div>
            </div>
          </div>

          <div class="grid two">
            <div class="panel">
              <div class="panel-head">
                <div class="panel-title">Последние события</div>
                <button class="btn ghost sm" id="refresh-events-mini">Обновить</button>
              </div>
              <div class="table-wrap">
                <table class="table" id="mini-events">
                  <thead><tr><th>ID</th><th>HUMid</th><th>user_id</th><th>event_type</th><th>IP</th><th>UA</th><th>Создано</th></tr></thead>
                  <tbody><tr><td colspan="7" class="muted">Загрузка…</td></tr></tbody>
                </table>
              </div>
            </div>

            <div class="panel">
              <div class="panel-head">
                <div class="panel-title">Последние дуэли</div>
                <button class="btn ghost sm" id="refresh-duels-mini">Обновить</button>
              </div>
              <div class="table-wrap">
                <table class="table" id="mini-duels">
                  <thead><tr><th>Время</th><th>id</th><th>vs</th><th>id</th><th class="right">stake</th><th>status</th><th class="right">pot</th><th class="right">rake</th></tr></thead>
                  <tbody><tr><td colspan="8" class="muted">Загрузка…</td></tr></tbody>
                </table>
              </div>
            </div>

            <div class="panel">
              <div class="panel-head">
                <div class="panel-title">Пользователи</div>
                <button class="btn ghost sm" id="refresh-users-mini">Обновить</button>
              </div>
              <div class="table-wrap">
                <table class="table" id="mini-users">
                  <thead>
                    <tr>
                      <th>HUMid</th>
                      <th>user_id</th>
                      <th>VK/Tg</th>
                      <th>Имя</th>
                      <th>Фамилия</th>
                      <th class="right">Баланс</th>
                      <th>Страна</th>
                      <th>Создан</th>
                      <th class="tight">vk/tg</th>
                      <th class="tight right">Аватар</th>
                    </tr>
                  </thead>
                  <tbody><tr><td colspan="10" class="muted">Загрузка…</td></tr></tbody>
                </table>
              </div>
            </div>

                        <div class="panel" id="panel-mini-topups">
              <div class="panel-head">
                <div class="panel-title">История ручных пополнений</div>
                <button class="btn ghost sm" id="refresh-topups-mini">Обновить</button>
              </div>
              <div class="table-wrap">
                <table class="table" id="mini-topups">
                  <thead>
                    <tr>
                      <th>Время</th>
                      <th>Админ</th>
                      <th>Кому (user / HUM)</th>
                      <th class="right">Сумма</th>
                      <th>Комментарий</th>
                    </tr>
                  </thead>
                  <tbody><tr><td colspan="5" class="muted">Загрузка…</td></tr></tbody>
                </table>
              </div>
            </div>
        </section>

        <section class="view" id="view-finance">
          <div class="panel">
            <div class="panel-head">
              <div class="panel-title">Финансы</div>
              <button class="btn sm" id="refresh-finance">Обновить</button>
            </div>

            <div class="grid cards small">
              <div class="card">
                <div class="card-title">Deposited</div>
                <div class="card-value" id="fin-deposited">—</div>
                <div class="card-sub muted tiny" id="fin-deposited-sub">withdrawn: —</div>
              </div>
              <div class="card">
                <div class="card-title">Liabilities</div>
                <div class="card-value" id="fin-liabilities">—</div>
                <div class="card-sub muted tiny">Σ balances</div>
              </div>
              <div class="card">
                <div class="card-title">Turnover / Rake</div>
                <div class="card-value"><span id="fin-turnover">—</span> / <span id="fin-rake" class="num-rake">—</span></div>
                <div class="card-sub muted tiny" id="fin-turnover-sub">—</div>
              </div>
            </div>

            <div class="note muted tiny">
              Сейчас deposited считаем по событиям (admin_topup / deposit). Позже добавим платёжки и выводы.
            </div>
          </div>
        </section>

        <section class="view" id="view-users">
  <div class="panel">
    <div class="panel-head">
      <div class="panel-title">Пользователи</div>
      <div class="panel-actions">
        <button class="btn sm ghost" id="users-clear">Сброс</button>
        <button class="btn sm" id="refresh-users">Обновить</button>
      </div>
    </div>

    <div class="subtabs" id="users-subtabs">
      <button class="chip active" data-users-sub="list">Список</button>
      <button class="chip" data-users-sub="analytics">Аналитика</button>
    </div>

    <div class="users-subview active" id="users-sub-list">
      <div class="filters users-filters">
        <label class="f">
          <span>vk/tg id</span>
          <input class="input sm" id="users-f-vkid" placeholder="107… или tg:…" />
        </label>
        <label class="f">
          <span>имя</span>
          <input class="input sm" id="users-f-first" placeholder="Alex" />
        </label>
        <label class="f">
          <span>фамилия</span>
          <input class="input sm" id="users-f-last" placeholder="Захаров" />
        </label>
        <label class="f">
          <span>HUMid</span>
          <input class="input sm" id="users-f-hum" inputmode="numeric" placeholder="97" />
        </label>
        <label class="f">
          <span>user_id</span>
          <input class="input sm" id="users-f-uid" inputmode="numeric" placeholder="97" />
        </label>
      </div>

      <div class="table-wrap">
        <table class="table users-table" id="tbl-users">
          <thead>
            <tr>
              <th class="sortable" data-sort="hum_id">HUMid</th>
              <th class="sortable" data-sort="id">user_id</th>
              <th class="sortable" data-sort="vk_tg">VK/Tg</th>
              <th class="sortable" data-sort="first_name">Имя</th>
              <th class="sortable" data-sort="last_name">Фамилия</th>
              <th class="sortable right" data-sort="balance">Баланс</th>
              <th class="sortable" data-sort="country_code">Страна</th>
              <th class="sortable" data-sort="created_at">Создан</th>
              <th class="sortable tight" data-sort="providers">vk/tg</th>
              <th class="tight">Аватар</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="10" class="muted">Загрузка…</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="users-subview" id="users-sub-analytics">
      <div class="panel-head panel-head-slim">
        <div class="panel-title">Самый активный в дуэлях</div>
        <div class="panel-actions">
          <button class="btn sm" id="refresh-users-analytics">Обновить</button>
        </div>
      </div>
      <div class="note muted tiny">Топ-10 по количеству участий в дуэлях за весь период (создатель + участник).</div>

      <div class="table-wrap">
        <table class="table" id="tbl-users-analytics-duels">
          <thead>
            <tr>
              <th class="right">#</th>
              <th>Пользователь</th>
              <th class="right">Участий</th>
              <th class="right">user_id</th>
              <th class="right">HUMid</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="5" class="muted">Загрузка…</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<section class="view" id="view-duels">

          <div class="panel">
            <div class="panel-head">
              <div>
                <div class="panel-title">Дуэли</div>
                <div class="muted tiny">Клик по заголовку — сортировка</div>
              </div>
              <div class="tools">
                <input class="input sm" id="duels-filter" placeholder="Фильтр: id:123 status:cancelled user:97 hum:1 stake:1000 creator:97 opponent:12 winner:45" />
                <button class="btn ghost sm" id="duels-filter-clear" title="Очистить фильтр">×</button>
                <button class="btn sm" id="refresh-duels">Обновить</button>
              </div>
            </div>
            <div class="note muted tiny">Показываем последние 200 дуэлей из базы (включая <code>cancelled</code>). Фильтр/сортировка — на клиенте.</div>
            <div class="table-wrap">
              <table class="table" id="tbl-duels">
                <thead>
                  <tr>
                    <th data-k="id" class="sortable">id</th>
                    <th data-k="mode" class="sortable">mode</th>
                    <th data-k="created_at" class="sortable">created</th>
                    <th data-k="stake" class="sortable right">stake</th>
                    <th data-k="status" class="sortable">status</th>
                    <th data-k="fee_bps" class="sortable right">fee_bps</th>
                    <th data-k="creator" class="sortable">creator</th>
                    <th data-k="opponent" class="sortable">opponent</th>
                    <th data-k="winner" class="sortable">winner</th>
                    <th data-k="finished_at" class="sortable">finished</th>
                  </tr>
                </thead>
                <tbody><tr><td colspan="10" class="muted">Загрузка…</td></tr></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="view" id="view-events">
          <div class="panel">
            <div class="panel-head">
              <div class="panel-title">События</div>
              <button class="btn sm" id="refresh-events">Обновить</button>
            </div>
            <div class="note muted tiny">Это “сырой” лог — очень полезно для отладки платёжек и спорных кейсов.</div>
            <div class="table-wrap">
              <table class="table" id="tbl-events">
                <thead><tr><th>ID</th><th>HUMid</th><th>user_id</th><th>event_type</th><th>IP</th><th>UA</th><th>Создано</th></tr></thead>
                <tbody><tr><td colspan="7" class="muted">Загрузка…</td></tr></tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="view" id="view-topup">
          <div class="panel">
            <div class="panel-head">
              <div class="panel-title">Ручное пополнение</div>
              <button class="btn ghost sm" id="topup-reload" title="Обновить историю">Обновить историю</button>
            </div>

            <div class="form">
              <div class="row">
                <label>user_id</label>
                <input class="input" id="topup-user" placeholder="например 97" />
              </div>
              <div class="row">
                <label>amount</label>
                <input class="input" id="topup-amount" placeholder="например 1000" />
              </div>
              <div class="row">
                <label>comment</label>
                <input class="input" id="topup-comment" placeholder="обязательно" />
              </div>
              <div class="row">
                <div></div>
                <button class="btn" id="topup-btn">Пополнить</button>
              </div>

              <pre class="out" id="topup-out"></pre>
              <div class="note muted tiny">Технически: POST /api/admin/users/:id/topup • Лог: последние 100 событий <code>admin_topup</code></div>
            </div>
          </div>

          <div class="panel" style="margin-top:12px">
                        <div class="panel-head">
              <div>
                <div class="panel-title">История ручных пополнений</div>
                <div class="muted tiny">Клик по заголовку — сортировка</div>
              </div>
              <div class="tools">
                <input class="input sm" id="topup-filter" placeholder="Фильтр: user:97 hum:12 admin:1 sum:1000 comment:текст" />
                <button class="btn ghost sm" id="topup-filter-clear" title="Очистить фильтр">×</button>
              </div>
            </div>

            <div class="table-wrap">
              <table class="table" id="tbl-topup">
                <thead>
                  <tr>
                    <th data-k="created_at" class="sortable">Время</th>
                    <th data-k="admin" class="sortable">Админ</th>
                    <th data-k="user" class="sortable">Кому (user_id / HUMid)</th>
                    <th data-k="amount" class="sortable right">Сумма</th>
                    <th data-k="comment" class="sortable">Комментарий</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="muted">Загрузка…</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <section class="view" id="view-unmerge">
          <div class="panel">
            <div class="panel-head">
              <div class="panel-title">Расклейка (unmerge)</div>
            </div>

            <div class="form">
              <div class="row">
                <label>hum_id</label>
                <input class="input" id="unmerge-hum" placeholder="например 1" />
              </div>
              <div class="row">
                <label>user_ids</label>
                <input class="input" id="unmerge-users" placeholder="например 97, 468" />
              </div>
              <div class="row">
                <label>reason</label>
                <input class="input" id="unmerge-reason" placeholder="почему расклеиваем" />
              </div>
              <div class="row">
                <div></div>
                <button class="btn danger" id="unmerge-btn">Расклеить</button>
              </div>

              <pre class="out" id="unmerge-out"></pre>
              <div class="note muted tiny">Технически: POST /api/admin/unmerge</div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- auth shim / hum toggle -->
  <script src="/admin/admin-auth-headers.js?v=20251224c"></script>

  <script src="/admin/admin2.js?v=20251225j"></script>
  <script src="/admin/chart-range.js?v=20251224c"></script>
  <script src="/admin/chart.js?v=20251224c"></script>
</body>
</html>
