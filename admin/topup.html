<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="api-base" content="https://vercel2pr.onrender.com"/>
  <title>Ручное пополнение</title>
  <style>
    body{font-family:Inter,system-ui,Arial,sans-serif;background:#0b1024;color:#e8f0ff;margin:0;padding:24px}
    .wrap{max-width:1040px;margin:0 auto;display:grid;gap:24px}
    .card{background:#121c2e;border:1px solid #23324a;border-radius:16px;padding:20px}
    .row{display:flex;gap:12px;margin-bottom:12px}
    label{width:120px;opacity:.8}
    input,textarea{flex:1;background:#0c1426;color:#e8f0ff;border:1px solid #2a3a57;border-radius:10px;padding:10px}
    button{background:#2b79ff;border:0;color:white;padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    .muted{opacity:.75}
    .log{margin-top:12px;font-size:13px;opacity:.9;white-space:pre-wrap}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid #23324a;border-radius:14px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid #1d2a40;font-size:14px}
    th{background:#0f1730;color:#9fb4d9;text-align:left;user-select:none;cursor:pointer}
    tr:nth-child(even) td{background:#0b1327}
    .pill{display:inline-block;min-width:44px;text-align:center;border-radius:999px;padding:2px 10px;font-weight:800}
    .pill-pos{background:#1f8a4c;color:#eafff3}
    .pill-neg{background:#a53b3b;color:#fff0f0}
    .pill-zero{background:#546179;color:#e6eefc}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Ручное пополнение</h2>
      <div class="row"><label>API</label><input id="api" placeholder="https://vercel2pr.onrender.com"></div>
      <div class="row"><label>Пароль</label><input id="pwd" type="password" placeholder="X-Admin-Password"></div>
      <div class="row"><label>User ID</label><input id="uid" type="number" placeholder="внутренний id (например, 97)"></div>
      <div class="row"><label>Сумма</label><input id="amt" type="number" placeholder="рубли"></div>
      <div class="row"><label>Комментарий</label><textarea id="cmt" rows="3" placeholder="обязательно"></textarea></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="save">Сохранить</button>
        <button id="go">Пополнить</button>
        <button id="reload">Обновить историю</button>
      </div>
      <div class="log" id="log"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 12px">История ручных пополнений</h3>
      <div class="muted" style="margin:-6px 0 10px">Показываем последние 100 событий типа <code>admin_topup</code>. Клик по заголовку сортирует.</div>
      <table id="tbl">
        <thead>
          <tr>
            <th data-sort="created_at">Время</th>
            <th data-sort="admin">Админ</th>
            <th data-sort="user_id">Кому (user_id / HUMid)</th>
            <th data-sort="amount">Сумма</th>
            <th data-sort="comment">Комментарий</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5" class="muted">Загрузка…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
  // ---- utils ---------------------------------------------------------------
  const $ = (s)=>document.querySelector(s);
  const log = (s)=>{ $('#log').textContent = String(s||''); };

  function apiBase(){
    const inField = ($('#api')?.value || '').trim();
    if (inField) return inField;
    try{ const ls = localStorage.getItem('admin_api'); if (ls) return ls; }catch{}
    const mt = document.querySelector('meta[name="api-base"]');
    return (mt?.content) || 'https://vercel2pr.onrender.com';
  }
  function adminPwd(){
    const inField = ($('#pwd')?.value || '').trim();
    if (inField) return inField;
    try{ const ls = localStorage.getItem('admin_pwd'); if (ls) return ls; }catch{}
    return '';
  }
  function setFromQS(){
    const p = new URLSearchParams(location.search);
    if (p.get('api')) $('#api').value = decodeURIComponent(p.get('api'));
    if (p.get('user_id')) $('#uid').value = p.get('user_id');
  }
  function hydrateFromLS(){
    try{
      const a = localStorage.getItem('admin_api'); if (a && !$('#api').value) $('#api').value = a;
      const pw = localStorage.getItem('admin_pwd'); if (pw && !$('#pwd').value) $('#pwd').value = pw;
    }catch{}
  }
  setFromQS(); hydrateFromLS();

  function headers(){ return { 'Content-Type':'application/json', 'X-Admin-Password': adminPwd() }; }

  async function post(url, body){
    const r = await fetch(url, { method:'POST', headers: headers(), body: JSON.stringify(body) });
    let data={}; try{ data = await r.json(); }catch{}
    return { r, data };
  }

  // ---- topup ---------------------------------------------------------------
  $('#save').addEventListener('click', ()=>{
    try{
      const a = ($('#api').value || '').trim();
      const p = ($('#pwd').value || '').trim();
      if (a) localStorage.setItem('admin_api', a);
      if (p) localStorage.setItem('admin_pwd', p);
      log('Сохранено');
    }catch(e){ log('Не удалось сохранить'); }
  });

  $('#go').addEventListener('click', async ()=>{
    const API = apiBase();
    const pwd = adminPwd();
    const uid = Number(($('#uid')?.value || '').trim());
    const amt = Number(($('#amt')?.value || '').trim());
    const cmt = ($('#cmt')?.value || '').trim();

    if(!API || !pwd || !uid || !amt || !cmt){ log('Заполни все поля'); return; }

    const { r, data } = await post(`${API}/api/admin/users/${uid}/topup`, {
      amount: amt, comment: cmt, value: amt, sum: amt, delta: amt,
      note: cmt, reason: cmt, description: cmt
    });

    if (!r.ok || data?.ok===false) {
      log(`Ошибка: ${data?.error || r.statusText || ('HTTP '+r.status)}`);
      return;
    }
    log('Готово: ' + JSON.stringify(data));
    try{ $('#amt').value=''; $('#cmt').value=''; }catch{}
    loadHistory().catch(()=>{});
  });

  // ---- history -------------------------------------------------------------
  let _rows = [];
  let _sort = { key: 'created_at', dir: 'desc' };

  function fmt(ts){ try{ return new Date(ts).toLocaleString(); }catch{ return ts; } }
  function pick(obj, keys, dflt){ for (const k of keys) { if (obj!=null && obj[k]!=null) return obj[k]; } return dflt; }

  async function fetchHistory(){
    const API = apiBase();
    const url = `${API}/api/admin/events?type=admin_topup&take=100&skip=0`;
    const r = await fetch(url, { headers: headers(), cache: 'no-store' });
    let data={}; try{ data = await r.json(); }catch{}
    if (!r.ok) throw new Error(data?.error || r.statusText || 'history_failed');
    return data?.events || data?.rows || [];
  }

  function cmp(a,b,key,dir){
    const mul = dir==='desc'?-1:1;
    const va = a[key]; const vb = b[key];
    if (key==='created_at') return mul * (new Date(va) - new Date(vb));
    if (key==='amount') return mul * ((Number(va)||0) - (Number(vb)||0));
    return mul * String(va??'').localeCompare(String(vb??''));
  }

  function render(){
    const tbody = $('#tbl tbody');
    tbody.innerHTML = '';
    const list = [..._rows].sort((a,b)=>cmp(a,b,_sort.key,_sort.dir));
    if (!list.length) {
      tbody.innerHTML = '<tr><td class="muted" colspan="5">Пока пусто</td></tr>';
      return;
    }
    for (const ev of list) {
      const when = ev.created_at;
      const uid  = ev.user_id;
      const hum  = ev.hum_id ?? ev.HUMid ?? '—';
      const amt  = Number(ev.amount || 0);
      const cmt  = String(ev.comment || '').trim();

      const cls = amt>0 ? 'pill-pos' : (amt<0 ? 'pill-neg' : 'pill-zero');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="muted">${fmt(when)}</td>
        <td>—</td>
        <td>${uid} / ${hum ?? '—'}</td>
        <td><span class="pill ${cls}">${amt>0?'+':''}${isFinite(amt)?amt:0}</span></td>
        <td>${cmt ? cmt.replace(/[<>]/g, s => s === '<' ? '&lt;' : '&gt;') : '—'}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function loadHistory(){
    try{
      _rows = await fetchHistory();
      render();
    }catch(e){
      log('Ошибка истории: ' + (e?.message || e));
      $('#tbl tbody').innerHTML = '<tr><td class="muted" colspan="5">Не удалось загрузить историю</td></tr>';
    }
  }

  // сортировка по клику
  document.querySelectorAll('#tbl thead th[data-sort]').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.getAttribute('data-sort');
      if (_sort.key === key) _sort.dir = (_sort.dir==='desc' ? 'asc' : 'desc');
      else { _sort.key = key; _sort.dir = 'desc'; }
      render();
    });
  });

  loadHistory().catch(()=>{});
</script>
</body>
</html>
