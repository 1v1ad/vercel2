<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="api-base" content="https://vercel2pr.onrender.com"/>
  <title>Ручное пополнение</title>
  <style>
    body{font-family:Inter,system-ui,Arial,sans-serif;background:#0b1024;color:#e8f0ff;margin:0;padding:24px}
    .wrap{max-width:1040px;margin:0 auto;display:grid;gap:24px}
    .card{background:#121c2e;border:1px solid #23324a;border-radius:16px;padding:20px}
    .row{display:flex;gap:12px;margin-bottom:12px}
    label{width:120px;opacity:.8}
    input,textarea{flex:1;background:#0c1426;color:#e8f0ff;border:1px solid #2a3a57;border-radius:10px;padding:10px}
    button{background:#2b79ff;border:0;color:white;padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    .log{margin-top:12px;font-size:13px;opacity:.9;white-space:pre-wrap}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid #23324a;border-radius:14px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid #1d2a40;font-size:14px}
    th{background:#0f1730;color:#9fb4d9;text-align:left;cursor:pointer;user-select:none}
    tr:nth-child(even) td{background:#0b1327}
    .muted{opacity:.75}
    .pill-ok{background:#1f8a4c;color:#eafff3;padding:2px 8px;border-radius:999px;font-weight:700}
    .pill-bad{background:#9b1c31;color:#ffecee;padding:2px 8px;border-radius:999px;font-weight:700}
    .th-active{color:#d6e6ff}
  </style>
  <link rel="icon" href="/assets/favicon.ico">
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Ручное пополнение</h2>
      <div class="row"><label>API</label><input id="api" placeholder="https://vercel2pr.onrender.com"></div>
      <div class="row"><label>Пароль</label><input id="pwd" type="password" placeholder="X-Admin-Password"></div>
      <div class="row"><label>User ID</label><input id="uid" type="number" placeholder="внутренний id (например, 97)"></div>
      <div class="row"><label>Сумма</label><input id="amt" type="number" placeholder="рубли"></div>
      <div class="row"><label>Комментарий</label><textarea id="cmt" rows="3" placeholder="обязательно"></textarea></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="save">Сохранить</button>
        <button id="go">Пополнить</button>
        <button id="reload">Обновить историю</button>
      </div>
      <div class="log" id="log"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 12px">История ручных пополнений</h3>
      <div class="muted" style="margin:-6px 0 10px">Показываем последние 100 событий типа <code>admin_topup</code>. Клик по заголовку сортирует.</div>
      <table id="tbl">
        <thead>
          <tr>
            <th data-sort="time">Время</th>
            <th>Админ</th>
            <th data-sort="uid">Кому (user_id / HUMid)</th>
            <th data-sort="amt">Сумма</th>
            <th>Комментарий</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5" class="muted">Загрузка…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
/** ==== utils ==== */
<script>
  const $ = (s)=>document.querySelector(s);
  const log = (s)=>{ $('#log')?.textContent = String(s||''); };

  function apiBase(){
    const p = new URLSearchParams(location.search);
    const fromQuery = p.get('api');
    if (fromQuery) return fromQuery;
    const inField = ($('#api')?.value || '').trim();
    if (inField) return inField;
    const mt = document.querySelector('meta[name="api-base"]');
    if (mt?.content) return mt.content;
    return 'https://vercel2pr.onrender.com';
  }
  function adminPwd(){
    const p = new URLSearchParams(location.search);
    return (p.get('pwd') || $('#pwd')?.value || '').trim();
  }
  (function setInitial(){
    const p = new URLSearchParams(location.search);
    if (p.get('api')) $('#api').value = p.get('api');
    if (p.get('user_id')) $('#uid').value = p.get('user_id');
  })();

  async function post(url, body, pwd){
    const r = await fetch(url, {
      method:'POST',
      headers: { 'Content-Type':'application/json', 'X-Admin-Password': pwd },
      body: JSON.stringify(body)
    });
    let data={}; try{ data=await r.json(); }catch{}
    return { r, data };
  }

  // Сохранить API/пароль в localStorage (чтобы не светить в адресной строке)
  $('#save')?.addEventListener('click', ()=>{
    try {
      localStorage.setItem('admin_api', ($('#api')?.value||'').trim());
      localStorage.setItem('admin_pwd', ($('#pwd')?.value||'').trim());
      log('Сохранено.');
    } catch {}
  });
  // Подставляем сохранённое
  (function loadSaved(){
    try{
      const a = localStorage.getItem('admin_api'); if (a) $('#api').value = a;
      const p = localStorage.getItem('admin_pwd'); if (p) $('#pwd').value = p;
    }catch{}
  })();

  $('#go').addEventListener('click', async ()=>{
    const API = apiBase();
    const pwd = adminPwd() || localStorage.getItem('admin_pwd') || '';
    const uid = Number(($('#uid')?.value || '').trim());
    const amt = Number(($('#amt')?.value || '').trim());
    const cmt = ($('#cmt')?.value || '').trim();

    if(!API || !pwd || !uid || !amt || !cmt){ log('Заполни все поля'); return; }

    const payload = { user_id: uid, amount: amt, comment: cmt };

    let { r, data } = await post(`${API}/api/admin/users/${uid}/topup`, payload, pwd);
    if (r.status === 404) { ({ r, data } = await post(`${API}/api/admin/topup`, payload, pwd)); }

    if (!r.ok || data?.ok===false) {
      log(`Ошибка: ${data?.error || r.statusText || ('HTTP '+r.status)}`);
    } else {
      log('Готово: ' + JSON.stringify(data));
      try{ $('#amt').value=''; $('#cmt').value=''; }catch{}
      loadHistory().catch(()=>{});
    }
  });

  // ====== HISTORY ======
  async function fetchHistory(){
    const API = apiBase();
    const pwd = adminPwd() || localStorage.getItem('admin_pwd') || '';
    const url = `${API}/api/admin/events?type=admin_topup&take=100&skip=0`;
    const r = await fetch(url, { headers: { 'X-Admin-Password': pwd } });
    let data={}; try{ data = await r.json(); }catch{}
    return { r, data };
  }

  function fmt(ts){ try{ return new Date(ts).toLocaleString(); }catch{ return ts; } }

  let lastRows = [];
  let sortKey = 'created_at';
  let sortDir = -1; // desc

  function applySort(arr){
    const a = [...arr];
    a.sort((x,y)=>{
      const vx = x[sortKey]; const vy = y[sortKey];
      if (vx==null && vy==null) return 0;
      if (vx==null) return 1;
      if (vy==null) return -1;
      if (sortKey === 'amount' || sortKey === 'user_id') {
        return (vx - vy) * sortDir;
      }
      // created_at string
      return (vx < vy ? -1 : vx > vy ? 1 : 0) * sortDir;
    });
    return a;
  }

  function renderHistory(list){
    lastRows = Array.isArray(list) ? list : [];
    const tbody = $('#tbl tbody');
    tbody.innerHTML = '';
    const rows = applySort(lastRows);

    if (!rows.length) {
      tbody.innerHTML = '<tr><td class="muted" colspan="5">Пока пусто</td></tr>';
      return;
    }
    for (const ev of rows) {
      const when = ev.created_at;
      const uid  = ev.user_id ?? '—';
      const hum  = ev.hum_id ?? ev.HUMid ?? '—';
      const amt  = Number(ev.amount || 0);
      const cmt  = (ev.comment || '—').toString();

      const pillClass = amt < 0 ? 'pill-neg' : 'pill-ok';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="muted">${fmt(when)}</td>
        <td>${ev.admin || '—'}</td>
        <td>${uid} / ${hum}</td>
        <td><span class="${pillClass}">${amt>0 ? '+'+amt : amt}</span></td>
        <td>${cmt.replace(/[<>]/g, s => s === '<' ? '&lt;' : '&gt;')}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function loadHistory(){
    const { r, data } = await fetchHistory();
    if (!r.ok || data?.ok===false) {
      log(data?.error || ('HTTP '+r.status)); return;
    }
    renderHistory(data?.events || data?.rows || []);
  }

  // Заголовки сортировки
  (function wireSort(){
    const ths = document.querySelectorAll('#tbl thead th');
    ths[0]?.addEventListener('click', ()=>{ sortKey='created_at'; sortDir = sortDir*(sortKey==='created_at'?-1:-1); renderHistory(lastRows); });
    ths[2]?.addEventListener('click', ()=>{ sortKey='user_id';   sortDir = sortKey==='user_id'? -sortDir : 1; renderHistory(lastRows); });
    ths[3]?.addEventListener('click', ()=>{ sortKey='amount';    sortDir = sortKey==='amount'? -sortDir : -1; renderHistory(lastRows); });
  })();

  $('#reload').addEventListener('click', ()=> loadHistory().catch(e=>log('Ошибка истории: '+e)));
  loadHistory().catch(()=>{});
</script>
<style>
  .pill-ok{background:#1f8a4c;color:#eafff3;padding:2px 8px;border-radius:999px;font-weight:700}
  .pill-neg{background:#a33a3a;color:#ffeaea;padding:2px 8px;border-radius:999px;font-weight:700}
</style>
 
</body>
</html>
