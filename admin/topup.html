<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="api-base" content="https://vercel2pr.onrender.com"/>
  <title>Ручное пополнение</title>
  <style>
    body{font-family:Inter,system-ui,Arial,sans-serif;background:#0b1024;color:#e8f0ff;margin:0;padding:24px}
    .wrap{max-width:1040px;margin:0 auto;display:grid;gap:24px}
    .card{background:#121c2e;border:1px solid #23324a;border-radius:16px;padding:20px}
    .row{display:flex;gap:12px;margin-bottom:12px}
    label{width:120px;opacity:.8}
    input,textarea{flex:1;background:#0c1426;color:#e8f0ff;border:1px solid #2a3a57;border-radius:10px;padding:10px}
    button{background:#2b79ff;border:0;color:white;padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    .log{margin-top:12px;font-size:13px;opacity:.9;white-space:pre-wrap}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid #23324a;border-radius:14px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid #1d2a40;font-size:14px}
    th{background:#0f1730;color:#9fb4d9;text-align:left}
    tr:nth-child(even) td{background:#0b1327}
    .muted{opacity:.75}
    .pill-ok{background:#1f8a4c;color:#eafff3;padding:2px 8px;border-radius:999px;font-weight:700}
  </style>
  <link rel="icon" href="/assets/favicon.ico">
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Ручное пополнение</h2>
      <div class="row"><label>API</label><input id="api" placeholder="https://vercel2pr.onrender.com"></div>
      <div class="row"><label>Пароль</label><input id="pwd" type="password" placeholder="X-Admin-Password"></div>
      <div class="row"><label>User ID</label><input id="uid" type="number" placeholder="внутренний id (например, 97)"></div>
      <div class="row"><label>Сумма</label><input id="amt" type="number" placeholder="рубли"></div>
      <div class="row"><label>Комментарий</label><textarea id="cmt" rows="3" placeholder="обязательно"></textarea></div>
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="save">Сохранить</button>
        <button id="go">Пополнить</button>
        <button id="reload">Обновить историю</button>
      </div>
      <div class="log" id="log"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 12px">История ручных пополнений</h3>
      <div class="muted" style="margin:-6px 0 10px">Показываем последние 100 событий типа <code>admin_topup</code>.</div>
      <table id="tbl">
        <thead>
          <tr>
            <th>Время</th>
            <th>Админ</th>
            <th>Кому (user_id / HUMid)</th>
            <th>Сумма</th>
            <th>Комментарий</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5" class="muted">Загрузка…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<script>
/** ==== utils ==== */
const $ = (s)=>document.querySelector(s);
const log = (s)=>{ $('#log').textContent = String(s||''); };

function apiBase(){
  const p = new URLSearchParams(location.search);
  const fromQuery = p.get('api');
  if (fromQuery) return fromQuery;
  const inField = ($('#api')?.value || '').trim();
  if (inField) return inField;
  const mt = document.querySelector('meta[name="api-base"]');
  if (mt?.content) return mt.content;
  return 'https://vercel2pr.onrender.com';
}
function adminPwd(){
  const q = new URLSearchParams(location.search).get('pwd');
  if (q) return q.trim();
  try {
    const s = sessionStorage.getItem('admin_pwd'); if (s) return s;
    const l = localStorage.getItem('admin_pwd');  if (l) return l;
  } catch {}
  return ($('#pwd')?.value || '').trim();
}
function setInitialFromStorage(){
  const p = new URLSearchParams(location.search);
  if (p.get('api')) $('#api').value = p.get('api');
  if (p.get('user_id')) $('#uid').value = p.get('user_id');
  try {
    const s = sessionStorage.getItem('admin_pwd') || localStorage.getItem('admin_pwd') || '';
    if (s) $('#pwd').value = s;
    const a = localStorage.getItem('admin_api') || '';
    if (a && !$('#api').value) $('#api').value = a;
  } catch {}
}
setInitialFromStorage();

async function post(url, body, pwd){
  const r = await fetch(url, {
    method:'POST',
    headers: { 'Content-Type':'application/json', 'X-Admin-Password': pwd },
    body: JSON.stringify(body)
  });
  let data={}; try{ data=await r.json(); }catch{}
  return { r, data };
}

$('#save').addEventListener('click', ()=>{
  const api = ($('#api')?.value || '').trim();
  const pwd = ($('#pwd')?.value || '').trim();
  try {
    if (api) localStorage.setItem('admin_api', api);
    if (pwd) localStorage.setItem('admin_pwd', pwd);
    log('Сохранено локально.');
  } catch { log('Не удалось сохранить в localStorage'); }
});

$('#go').addEventListener('click', async ()=>{
  const API = apiBase();
  const pwd = adminPwd();
  const uid = Number(($('#uid')?.value || '').trim());
  const amt = Math.trunc(Number(($('#amt')?.value || '').trim() || 0));
  const cmt = ($('#cmt')?.value || '').trim();

  if(!API || !pwd || !uid || !amt || !cmt){ log('Заполни все поля (нужны API, пароль, user_id, сумма ≠ 0, комментарий).'); return; }

  // Разрешаем и положительные, и отрицательные суммы
  const payload = {
    user_id: uid, amount: amt, comment: cmt,
    value: amt, sum: amt, delta: amt,
    note: cmt, reason: cmt, description: cmt
  };

  let { r, data } = await post(`${API}/api/admin/users/${uid}/topup`, payload, pwd);
  if (r.status === 404) { ({ r, data } = await post(`${API}/api/admin/topup`, payload, pwd)); }

  if (!r.ok || data?.ok===false) {
    log(`Ошибка: ${data?.error || r.statusText || ('HTTP '+r.status)}`);
  } else {
    log('Готово: ' + JSON.stringify(data));
    try{ $('#amt').value=''; $('#cmt').value=''; }catch{}
    loadHistory().catch(()=>{});
  }
});

/** ====== HISTORY ====== */
async function fetchHistory(){
  const API = apiBase();
  const pwd = adminPwd();

  // Только заголовок — без передачи пароля в URL
  const variants = [
    `${API}/api/admin/events?type=admin_topup&take=100&skip=0`,
    `${API}/api/admin/events?take=100&skip=0&search=admin_topup`
  ];
  for (const url of variants) {
    const r = await fetch(url, { headers: { 'X-Admin-Password': pwd }, cache:'no-store' });
    try {
      if (r.ok) {
        const data = await r.json();
        return { r, data };
      }
    } catch {}
  }
  return { r: { ok:false, status:500 }, data:{} };
}

function fmt(ts){ try{ return new Date(ts).toLocaleString(); }catch{ return ts; } }
function pick(obj, keys, dflt){ for (const k of keys) { if (obj!=null && obj[k]!=null) return obj[k]; } return dflt; }

// вспомогалка для старых записей без amount
function computeDeltas(list){ return list.map(x=>({ raw:x, when: x.created_at || x.ts || x.time, uid: x.user_id, hum: x.HUMid, amt: Number(x.amount||0) })); }

function renderHistory(listRaw){
  const tbody = $('#tbl tbody');
  tbody.innerHTML = '';
  if (!Array.isArray(listRaw) || !listRaw.length) {
    tbody.innerHTML = '<tr><td class="muted" colspan="5">Пока пусто</td></tr>';
    return;
  }

  const withFallback = computeDeltas(listRaw);

  for (const r of withFallback) {
    const ev = r.raw || {};
    const p  = ev.payload || {};
    const when = r.when;
    const who  = pick(ev, ['admin','admin_id','actor'], pick(p, ['admin','admin_id','actor'], '—'));
    const uid  = r.uid ?? '—';
    const hum  = r.hum ?? '—';

    let amt = Number(pick(ev, ['amount'], null));
    if (!Number.isFinite(amt)) amt = Number(pick(p, ['amount','value','sum','delta'], null));
    if (!Number.isFinite(amt)) amt = Number(r.amt || 0);

    const cmt = String(
      pick(ev, ['comment'], pick(p, ['comment','note','reason','description'], '')) || ''
    );

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="muted">${fmt(when)}</td>
      <td>${who || '—'}</td>
      <td>${uid} / ${hum}</td>
      <td><span class="pill-ok">+${Number.isFinite(amt)?amt:0}</span></td>
      <td>${cmt ? cmt.replace(/[<>]/g, s => s === '<' ? '&lt;' : '&gt;') : '—'}</td>
    `;
    tbody.appendChild(tr);
  }
}

async function loadHistory(){
  const { r, data } = await fetchHistory();
  if (r.status === 401) { log('401: проверь пароль (поле «Пароль») и нажми «Обновить историю».'); }
  const list = data?.events || data?.rows || data?.list || [];
  renderHistory(list);
}

$('#reload').addEventListener('click', ()=> loadHistory().catch(e=>log('Ошибка истории: '+e)));
loadHistory().catch(()=>{});
</script>
</body>
</html>
