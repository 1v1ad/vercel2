<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Бэкенд и ID бота -->
  <meta name="api-base" content="https://vercel2pr.onrender.com">
  <meta name="tg-bot-id" content="8236271394">

  <title>GG ROOM — Лобби</title>

  <!-- FAVICONS -->
  <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16.png">
  <link rel="shortcut icon" href="/assets/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
  <link rel="manifest" href="/assets/site.webmanifest">

  <!-- UI tokens (единая палитра/радиусы/тени) -->
  <link rel="stylesheet" href="/css/ui-tokens.css">

  <style>
    *{box-sizing:border-box}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }

    /* =========================
   TopBar (покерный стиль)
   ========================= */
.hdr{
  position:sticky; top:0; z-index:50;
  display:flex; align-items:center; justify-content:space-between;
  gap:12px;
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  background:linear-gradient(180deg, rgba(15,19,27,.96), rgba(11,13,18,.96));
  backdrop-filter: blur(10px);
}
.hdr-left{ display:flex; align-items:center; gap:12px; min-width:0; }
.hdr-brand{
  display:flex; align-items:baseline; gap:8px;
  font-weight:900; letter-spacing:.3px;
  white-space:nowrap;
}
.hdr-brand .gg{
  background:linear-gradient(90deg,#ff3b3b,#2dd4bf);
  -webkit-background-clip:text; background-clip:text; color:transparent;
}
.hdr-brand .room{ color:var(--text); opacity:.92; }
.hdr-title{ color:var(--muted); font-weight:700; white-space:nowrap; }

.hdr-nav{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:6px;
  flex:1;
  min-width:220px;
}

/* Main tabs (Дуэли / Розыгрыши) */
.hdr-main{
  display:flex; align-items:center; gap:6px;
  padding:6px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(18,22,33,.28);
}
.hdr-main-tab{
  border:1px solid var(--border);
  background:rgba(18,22,33,.55);
  color:var(--muted);
  padding:8px 12px;
  border-radius:999px;
  font-weight:900;
  cursor:pointer;
  user-select:none;
  white-space:nowrap;
}
.hdr-main-tab:hover{ filter:brightness(1.06); }
.hdr-main-tab.is-active{
  color:var(--text);
  border-color:rgba(244,216,138,.40);
  background:rgba(244,216,138,.08);
}

/* Second-level sub-nav */
.hdr-sub{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  flex-wrap:wrap;
}

.side-label.is-click{cursor:pointer;}
.side-label.is-click:hover{color:var(--text);}
.hdr-nav a{
  display:inline-flex; align-items:center; justify-content:center;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  color:var(--muted);
  text-decoration:none;
  background:rgba(18,22,33,.55);
  font-weight:700;
  white-space:nowrap;
}
.hdr-nav a:hover{ filter:brightness(1.08); }

.hdr-sep{
  width:1px; height:22px;
  background:var(--border);
  border-radius:1px;
  opacity:.9;
  margin:0 4px;
}
.lotteries{
  display:grid;
  grid-template-columns:repeat(3, minmax(0, 1fr));
  gap:10px;
  margin-top:12px;
}
@media (max-width: 980px){ .lotteries{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
@media (max-width: 560px){ .lotteries{ grid-template-columns:repeat(1, minmax(0,1fr)); } }
.lottery-card[aria-disabled="true"]{ cursor:default; }

/* lottery tabs */
.lot-tabs{ margin-top:12px; }
.lot-tabs button{ padding:8px 12px; }

/* Вкладки розыгрышей переезжают в topbar sub-nav (чтобы было как «второй режим продукта»).
   Внутри карточки оставляем только на мобильных как fallback. */
@media (min-width: 981px){
  #lottery-card .lot-tabs{ display:none; }
}
.lot-pane{ display:none; }
.lot-pane.is-active{ display:block; }
.lot-empty{ padding:14px; border-radius:16px; border:1px dashed rgba(255,255,255,.14); background:rgba(18,22,33,.35); }
.lot-empty .title{ font-weight:900; margin-bottom:6px; }
.lot-table{ width:100%; border-collapse:separate; border-spacing:0 10px; margin-top:8px; }
.lot-row{ background:rgba(18,22,33,.45); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px 12px; }
.lot-row .r{ display:flex; justify-content:space-between; gap:10px; align-items:center; }
.lot-row .k{ color:var(--muted); font-size:12px; font-weight:800; }
.lot-row .v{ font-weight:900; }

.hdr-nav a.is-active{
  color:var(--text);
  border-color:rgba(45,212,191,.35);
  background:rgba(45,212,191,.10);
}

.hdr-right{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

/* Base UI */
.btn{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#121621;
  color:var(--text);
  text-decoration:none;
  white-space:nowrap;
  cursor:pointer;
  user-select:none;
}
.btn:hover{ filter:brightness(1.06); }
.btn.primary{
  background:linear-gradient(180deg,#1b2234,#121621);
  border-color:rgba(244,216,138,.35);
  color:var(--gold);
}
.btn.ghost{
  background:rgba(18,22,33,.55);
}

.pill{
  display:inline-flex; align-items:center; gap:6px;
  padding:8px 12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(18,22,33,.55);
  color:var(--text);
  font-weight:800;
}
.hdr-user{
  display:flex; align-items:center; gap:10px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(18,22,33,.55);
  min-width:0;
}
.hdr-user img{ width:34px; height:34px; border-radius:50%; object-fit:cover; background:#222; }
.hdr-user .name{ display:flex; flex-direction:column; min-width:0; }
.hdr-user .name strong{ font-size:13px; line-height:1.1; max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.hdr-user .name span{ font-size:12px; color:var(--muted); line-height:1.1; }

@media (max-width: 980px){
  .hdr{ flex-wrap:wrap; }
  .hdr-nav{ order:3; width:100%; align-items:flex-start; }
  .hdr-sub{ justify-content:flex-start; }
  .hdr-right{ width:100%; justify-content:space-between; }
  .hdr-user .name strong{ max-width:160px; }
}
@media (max-width: 420px){
  .hdr-title{ display:none; }
}

    .wrap{ max-width:1280px; margin:0 auto; padding:18px 16px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px }
    /* =========================
       Layout (Sidebar / Main / Right rail)
       ========================= */
    html{ scroll-behavior:smooth; }

    .layout{
      display:grid;
      grid-template-columns: 260px minmax(0,1fr) 320px;
      gap:14px;
      align-items:start;
    }
    .sidebar, .rail{
      position:sticky;
      top:74px; /* высота topbar + небольшой отступ */
      align-self:start;
    }
    .main{ min-width:0; }

    .side-card{ padding:14px; }
    .side-title{ font-weight:900; margin:0 0 10px; font-size:14px; letter-spacing:.2px; color:var(--text); }
    .side-nav{ display:flex; flex-direction:column; gap:14px; }
    .side-group{ display:flex; flex-direction:column; gap:8px; }
    .side-label{ font-size:11px; letter-spacing:.14em; text-transform:uppercase; color:var(--muted); font-weight:900; margin:0 10px; }

    .side-link{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(18,22,33,.55);
      color:var(--text);
      text-decoration:none;
      font-weight:800;
    }
    .side-link span{ color:var(--muted); font-weight:700; }
    .side-link:hover{ filter:brightness(1.06); }
    .side-link.is-active{
      border-color:rgba(45,212,191,.35);
      background:rgba(45,212,191,.10);
    }

    .rail .card{ padding:14px; }
    .rail h3{ margin:0 0 8px; font-size:14px; font-weight:900; letter-spacing:.2px; }
    .rail .small{ font-size:13px; color:var(--muted); line-height:1.4; }
    .rail .kpi{
      display:grid; grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .rail .kpi .k{ padding:10px 12px; border-radius:14px; border:1px solid var(--border); background:#0c1018; }
    .rail .kpi .k .t{ font-size:12px; color:var(--muted); }
    .rail .kpi .k .v{ font-size:16px; font-weight:900; margin-top:4px; }

    @media (max-width: 1180px){
      .layout{ grid-template-columns: 240px minmax(0,1fr); }
      .rail{ position:static; grid-column: 2; justify-self:stretch; }
    }
    @media (max-width: 900px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar{ position:static; }
      .rail{ position:static; grid-column: 2; justify-self:stretch; }
    }


    /* --- duels (1v1) --- */
    .grid{ display:grid; grid-template-columns:1fr; gap:14px; }
    .card h2{ margin:0 0 10px; font-size:18px; }
    .muted{ color:var(--muted); }

    .duels-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .duels-head .right{ display:flex; align-items:center; gap:8px; }

    .btn.primary{ background:linear-gradient(180deg,#1b2234,#121621); border-color:rgba(244,216,138,.35); color:var(--gold); }
    .btn.primary:hover{ filter:brightness(1.05); }
    .btn.danger{ border-color:rgba(255,59,59,.35); color:#ffb3b3; }

    .duels-create{ border-top:1px dashed var(--border); margin-top:12px; padding-top:12px; }
    .stakes{ display:grid; grid-template-columns:repeat(5, minmax(0,1fr)); gap:10px; margin:10px 0 12px; }
@media (max-width: 980px){ .stakes{ grid-template-columns:repeat(3, minmax(0,1fr)); } }
@media (max-width: 560px){ .stakes{ grid-template-columns:repeat(2, minmax(0,1fr)); } }

.stake-chip{
  display:flex; flex-direction:column; align-items:flex-start; gap:4px;
  padding:12px 12px;
  border-radius:14px; border:1px solid var(--border);
  background:rgba(18,22,33,.55);
  color:var(--text); cursor:pointer;
  text-align:left;
  transition:transform .15s ease, border-color .15s ease, box-shadow .15s ease;
}
.stake-chip:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,.18); }
.stake-chip .amt{ font-weight:900; font-size:16px; letter-spacing:.2px; }
.stake-chip .meta{ font-size:12px; color:var(--muted); line-height:1.15; }
.stake-chip.is-selected{
  border-color: rgba(244,216,138,.55);
  box-shadow: 0 0 0 3px rgba(244,216,138,.12) inset, 0 12px 22px rgba(0,0,0,.22);
}
    .stake-chip:hover{ filter:brightness(1.06); }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row input{
      width:160px; max-width:100%; padding:10px 12px;
      border-radius:12px; border:1px solid var(--border);
      background:#0b0f18; color:var(--text);
      outline:none;
    }
    .row input:focus{ border-color:rgba(244,216,138,.45); }
    .hint{ margin-top:8px; font-size:13px; color:var(--muted); }

    .duels-list{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:12px; }
    .duel-item{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border-radius:14px; border:1px solid var(--border); background:#0c1018; }
    .duel-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .duel-left img{ width:38px; height:38px; border-radius:12px; object-fit:cover; background:#222; }
    .duel-title{ font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .duel-sub{ font-size:12px; color:var(--muted); }
    .duel-actions{ display:flex; align-items:center; gap:8px; }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#0f1219; border:1px solid var(--border); border-radius:14px;
      padding:12px 14px; max-width:min(560px, calc(100vw - 24px));
      box-shadow:0 12px 30px rgba(0,0,0,.4);
      z-index:9999; display:none;
    }
    .toast.show{ display:block; }
    .toast .t{ font-weight:800; margin-bottom:4px; }
    .toast .b{ color:var(--muted); font-size:13px; }

    /* бренд-вид кнопок рядом с балансом */
    .hdr-user .btn.vk { background:#2787F5; border-color:#2787F5; color:#fff; }
    .hdr-user .btn.tg { background:#229ED9; border-color:#229ED9; color:#fff; }
    .hdr-user .btn.vk:hover, .hdr-user .btn.tg:hover { filter:brightness(1.05); }

    /* на всякий случай вырубаем старый блок линковок, если где-то остался */
    #link-actions{ display:none !important; }
  

.section-title{ margin-top:14px; display:flex; align-items:baseline; justify-content:space-between; gap:10px; }
.section-title .h3{ font-size:18px; font-weight:700; }
.history-list{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px; }
.history-item{ cursor:pointer; padding:10px 12px; border-radius:14px; border:1px solid var(--border); background:#0c1018; display:flex; align-items:center; justify-content:space-between; gap:10px; }
.history-left{ display:flex; flex-direction:column; gap:2px; }
.history-right{ text-align:right; display:flex; flex-direction:column; gap:2px; }
.history-top{ display:flex; align-items:center; gap:10px; min-width:0; }
.history-avatars{ display:flex; gap:8px; align-items:center; flex:0 0 auto; }
.history-avatars img{ width:28px; height:28px; border-radius:10px; object-fit:cover; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); }
.history-info{ min-width:0; }
.history-title-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.history-title-row .duel-title{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.pill{ display:inline-flex; align-items:center; padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:12px; color:var(--muted); }
.pill.win{ color:#4ed1a9; border-color:rgba(78,209,169,.35); }
.pill.lose{ color:#ff6b6b; border-color:rgba(255,107,107,.35); }
.pill.cancel{ color:#c7c7c7; border-color:rgba(199,199,199,.25); }

/* modal */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:9999; padding:18px; }
.modal{ width:min(720px, 100%); border-radius:18px; border:1px solid var(--border); background:#0b0f18; box-shadow:0 20px 60px rgba(0,0,0,.5); }
.modal-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.06); }
.modal-title{ font-weight:800; }
.modal-close{ cursor:pointer; border:1px solid var(--border); background:#0c1018; color:var(--text); padding:6px 10px; border-radius:10px; }
.modal-body{ padding:14px 16px; color:var(--text); }
.kv{ display:grid; grid-template-columns: 160px 1fr; gap:8px 12px; font-size:14px; }
.kv .k{ color:var(--muted); }
.kv .v{ color:var(--text); overflow-wrap:anywhere; }

/* coin overlay */
.coin-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.70); display:none; align-items:center; justify-content:center; z-index:10000; }
.coin-card{ width:min(520px, 92vw); border-radius:18px; border:1px solid var(--border); background:#0b0f18; padding:18px; text-align:center; }
.coin{ width:90px; height:90px; margin:10px auto 12px; border-radius:50%; border:2px solid rgba(255,215,0,.55); background:radial-gradient(circle at 30% 30%, rgba(255,215,0,.95), rgba(255,215,0,.25)); animation: coinFlip 1.05s linear infinite; }
.coin-text{ font-size:15px; color:var(--muted); }
@keyframes coinFlip{ 0%{ transform:rotateY(0deg) rotateX(0deg); } 50%{ transform:rotateY(180deg) rotateX(14deg); } 100%{ transform:rotateY(360deg) rotateX(0deg); } }

/* ===== Step 1.5: режимы создания комнат ===== */
.mode-line{
  margin-top:10px;
  display:flex; align-items:center; gap:8px;
  flex-wrap:wrap;
  font-size:13px;
}
.mode-pill{
  display:inline-flex; align-items:center; gap:8px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(18,22,33,.55);
  color:var(--text);
  font-weight:800;
}
.mode-pill .tag{
  font-weight:900;
  font-size:11px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(45,212,191,.35);
  background:rgba(45,212,191,.10);
  color:#8ff3df;
}
.mode-link{
  color:var(--muted);
  text-decoration:none;
  border-bottom:1px dashed rgba(255,255,255,.18);
}
.mode-link:hover{ color:var(--text); }

.split-btn{
  display:inline-flex; gap:8px; align-items:center;
}
.btn.icon{
  width:40px; justify-content:center; padding:8px 0;
  border-radius:12px;
}

/* create-mode modal */
.seg{
  display:flex; gap:8px; flex-wrap:wrap;
  margin:6px 0 14px;
}
.seg button{
  padding:9px 12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(18,22,33,.55);
  color:var(--muted);
  font-weight:900;
  cursor:pointer;
}
.seg button:hover{ filter:brightness(1.06); }
.seg button.is-active{
  color:var(--text);
  border-color:rgba(244,216,138,.50);
  box-shadow:0 0 0 3px rgba(244,216,138,.10) inset;
}
.mode-pane{ display:none; }
.mode-pane.is-active{ display:block; }

.field{
  display:flex; flex-direction:column; gap:6px;
  margin-top:10px;
}
.field label{ font-size:12px; color:var(--muted); font-weight:800; }
.field input, .field select{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#0b0f18;
  color:var(--text);
  outline:none;
}
.field input:focus, .field select:focus{ border-color:rgba(244,216,138,.45); }

.modal-foot{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:14px 16px;
  border-top:1px solid rgba(255,255,255,.06);
}
.modal-foot .left{ color:var(--muted); font-size:12px; }
.modal-foot .actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.badge-soon{
  display:inline-flex; align-items:center;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,107,107,.35);
  background:rgba(255,107,107,.08);
  color:#ffb3b3;
  font-weight:900;
  font-size:11px;
}


/* lottery hero */
.lot-hero{
  display:flex; gap:14px; align-items:stretch; justify-content:space-between;
  padding:14px; border-radius:16px;
  border:1px solid var(--border);
  background: linear-gradient(110deg, rgba(24,36,56,.75), rgba(18,22,33,.55) 40%, rgba(16,48,40,.35));
  box-shadow: var(--shadow);
  margin-top:12px;
}
.lot-hero .left{ flex:1; min-width:0; }
.lot-hero .right{ width:230px; display:flex; flex-direction:column; gap:10px; align-items:flex-end; justify-content:space-between; }
.lot-hero .badge{
  display:inline-flex; align-items:center; gap:8px;
  font-weight:900; font-size:12px; letter-spacing:.04em;
  padding:6px 10px; border-radius:999px;
  background: rgba(45,212,191,.12);
  border:1px solid rgba(45,212,191,.35);
  color: rgba(167,243,208,1);
}
.lot-hero .title{ font-size:18px; font-weight:950; margin-top:8px; }
.lot-hero .sub{ margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35; }
.lot-hero .prog{ margin-top:10px; }
.lot-hero .bar{
  height:10px; border-radius:999px; overflow:hidden;
  background: rgba(148,163,184,.12);
  border:1px solid rgba(148,163,184,.16);
}
.lot-hero .fill{
  height:100%;
  background: linear-gradient(90deg, rgba(34,211,238,.95), rgba(34,197,94,.95));
  width:34%;
}
.lot-hero .meta-line{ margin-top:8px; font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; }
.lot-hero .count{
  width:100%;
  padding:10px 12px; border-radius:14px;
  border:1px solid var(--border);
  background: rgba(18,22,33,.55);
}
.lot-hero .count .k{ color:var(--muted); font-size:12px; }
.lot-hero .count .v{ font-size:16px; font-weight:950; margin-top:4px; }

.lot-table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  overflow:hidden;
  border-radius:14px;
  border:1px solid var(--border);
  background: rgba(18,22,33,.45);
}
.lot-table th, .lot-table td{
  padding:10px 12px;
  border-bottom:1px solid rgba(148,163,184,.12);
  font-size:13px;
}
.lot-table th{
  color:var(--muted);
  font-weight:900;
  text-align:left;
  background: rgba(18,22,33,.55);
}
.lot-table tr:last-child td{ border-bottom:none; }
.lot-table .pill{
  display:inline-flex; padding:4px 10px; border-radius:999px;
  border:1px solid rgba(148,163,184,.18);
  background: rgba(148,163,184,.08);
  font-weight:900;
}
.side-sub{
  margin-top:10px; display:flex; flex-direction:column; gap:6px;
}
.side-sub a{
  display:flex; justify-content:space-between; align-items:center;
  padding:10px 12px; border-radius:12px;
  background: rgba(18,22,33,.45);
  border:1px solid rgba(148,163,184,.12);
  color: var(--text);
  text-decoration:none;
  font-weight:800;
  font-size:13px;
  opacity:.9;
}
.side-sub a.is-active{
  border-color: rgba(34,211,238,.4);
  box-shadow: 0 0 0 1px rgba(34,211,238,.2) inset;
  opacity:1;
}
.side-sub a span{
  color: var(--muted);
  font-weight:900;
  font-size:12px;
}
@media (max-width: 980px){
  .lot-hero{ flex-direction:column; }
  .lot-hero .right{ width:100%; align-items:stretch; }
}
</style>
</head>
<body>
  <header class="hdr">
  <div class="hdr-left">
    <a class="btn hdr-back" href="/index.html" title="На главную">
      <span aria-hidden="true">←</span>
      <span class="label">На главную</span>
    </a>

    <div class="hdr-brand" aria-label="GGROOM">
      <span class="gg">GG</span><span class="room">ROOM</span>
    </div>
    <div class="hdr-title">Лобби</div>
  </div>

  <nav class="hdr-nav" aria-label="Навигация">
    <!-- main tabs (Дуэли / Розыгрыши) -->
    <div class="hdr-main" role="tablist" aria-label="Основные разделы">
      <button type="button" class="hdr-main-tab is-active is-click" data-main="duels" data-hash="#stakes">Дуэли</button>
      <button type="button" class="hdr-main-tab is-click" data-main="lottery" data-hash="#lottery">Розыгрыши</button>
    </div>

    <!-- sub-nav (второй уровень) -->
    <div class="hdr-sub" id="hdr-sub-duels" aria-label="Дуэли: подразделы">
      <a href="#stakes" class="is-active">Ставки</a>
      <a href="#live">Live</a>
      <a href="#archive">Архив</a>
    </div>

    <div class="hdr-sub" id="hdr-sub-lottery" aria-label="Розыгрыши: подразделы" style="display:none">
      <a href="#lottery" data-lot-jump="active">Активные</a>
      <a href="#lottery" data-lot-jump="archive">Архив</a>
      <a href="#lottery" data-lot-jump="mine">Мои билеты</a>
    </div>
  </nav>

  <div class="hdr-right">
    <span class="pill" id="user-balance">
      ₿ <span class="balance-amount" data-balance="">0</span>
    </span>

    <a class="btn primary" href="#" id="topup-btn" title="Пополнить баланс">Пополнить</a>

    <button class="btn ghost" id="link-tg" style="display:none" type="button">Связать Telegram</button>
    <button class="btn ghost" id="link-vk" style="display:none" type="button">Связать ВКонтакте</button>

    <div class="hdr-user">
      <img id="user-avatar" alt="avatar" referrerpolicy="no-referrer" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80'%3E%3Crect width='80' height='80' rx='40' fill='%23222'/%3E%3Ctext x='40' y='48' text-anchor='middle' font-size='28' fill='%23aaa' font-family='Arial'%3EGG%3C/text%3E%3C/svg%3E">
      <div class="name">
        <strong id="user-name-text">Гость</strong>
        <span>Профиль</span>
      </div>
    </div>
  </div>
</header>


  <div class="wrap">
    <div class="layout">
      <aside class="sidebar" aria-label="Боковая панель">
        <div class="card side-card">
          <h3 class="side-title">Навигация</h3>
          <nav class="side-nav">
            <div class="side-group">
              <div class="side-label">Дуэли</div>
              <a class="side-link" href="#stakes">Ставки <span>создать</span></a>
              <a class="side-link" href="#live">Live <span>комнаты</span></a>
              <a class="side-link" href="#archive">Архив <span>история</span></a>
            </div>

            <div class="side-group">
              <div class="side-label is-click" data-hash="#lottery" role="link" tabindex="0">Розыгрыши</div>
              <a class="side-link" href="#lottery">Розыгрыши <span>призы</span></a>

<div class="side-sub" id="lottery-subnav" style="display:none">
  <a href="#lottery" data-lot-jump="active"><span>раздел</span> Активные</a>
  <a href="#lottery" data-lot-jump="archive"><span>раздел</span> Архив</a>
  <a href="#lottery" data-lot-jump="mine"><span>раздел</span> Мои билеты</a>
</div>
            </div>
          </nav>
        </div>

        <div class="card side-card" style="margin-top:14px">
          <h3 class="side-title">Подсказка</h3>
          <div class="muted" style="font-size:13px; line-height:1.45">
            Выбирай ставку → создай комнату → дождись соперника.
            Победителя определяет coinflip. Детали дуэли можно открыть по клику в истории.
          </div>
        </div>
      </aside>

      <main class="main" aria-label="Основной контент">
        <div class="grid">

      <div id="hub-duels">


      <div class="card">
        <p style="margin:0">Добро пожаловать в лобби.</p>
        <p id="provider-note" style="margin:8px 0 0; color:var(--muted)"></p>
      </div>

      <div class="card" id="duels-card">
        <div id="stakes" class="duels-head">
          <h2 style="margin:0">Дуэли 1v1</h2>
          <div class="right">
            <button class="btn" id="duels-refresh" type="button">Обновить</button>
          </div>
        </div>

        <div class="duels-create">
          <div class="muted" style="font-size:13px">
            Создай комнату со ставкой — второй игрок заходит, и система честно кидает монету (coinflip).
          </div>

          <div class="stakes" aria-label="Быстрые ставки">

            <button class="stake-chip is-selected" data-stake="100" type="button">
              <div class="amt">₽100</div>
              <div class="meta">pot ₽200 • fee ~₽10</div>
            </button>
            <button class="stake-chip" data-stake="250" type="button">
              <div class="amt">₽250</div>
              <div class="meta">pot ₽500 • fee ~₽25</div>
            </button>
            <button class="stake-chip" data-stake="500" type="button">
              <div class="amt">₽500</div>
              <div class="meta">pot ₽1 000 • fee ~₽50</div>
            </button>
            <button class="stake-chip" data-stake="1000" type="button">
              <div class="amt">₽1 000</div>
              <div class="meta">pot ₽2 000 • fee ~₽100</div>
            </button>
            <button class="stake-chip" data-stake="2500" type="button">
              <div class="amt">₽2 500</div>
              <div class="meta">pot ₽5 000 • fee ~₽250</div>
            </button>
          </div>

          
<div class="row">
  <input id="stake-input" inputmode="numeric" type="number" min="10" max="1000000" step="10" value="100" />
  <span class="split-btn">
    <button class="btn primary" id="duels-create" type="button">Создать комнату</button>
    <button class="btn ghost icon" id="create-mode-btn" type="button" title="Режим комнаты" aria-label="Режим комнаты">⚙</button>
  </span>
</div>

<div class="mode-line" aria-label="Режим создания">
  <span class="muted">Режим:</span>
  <span class="mode-pill" id="create-mode-pill"><span class="tag">1v1</span> Публичная дуэль</span>
  <a class="mode-link" href="#" id="create-mode-link">изменить</a>
</div>

<div class="hint" id="duels-hint">Комиссия сейчас фиксированная: 5% (пока только в логе). Скоро подключим «дом».</div>
        </div>

        <div id="live"></div>
   <div class="duels-list" id="duels-list">
  <div class="muted">Загружаю комнаты…</div>
</div>

<div id="archive"></div>
   <div class="section-title">
  <div class="h3">История</div>
  <div class="muted">последние игры</div>
</div>
<div class="history-list" id="history-list">
  <div class="muted">Загружаю историю…</div>
</div>
      </div>



      </div>

      <div id="hub-lottery" style="display:none">
<div class="card" id="lottery-card" style="margin-top:14px">
  <div id="lottery" class="duels-head">
    <h2 style="margin:0">Розыгрыши</h2>
    <div class="right">
      <span class="pill" style="background:rgba(18,22,33,.55); border:1px solid var(--border); color:var(--muted); font-weight:800;">
        Скоро
      </span>
    </div>
  </div>

  <div class="muted" style="font-size:13px; margin-top:8px">
    Розыгрыши — отдельный раздел GGRoom (айфон/авто/кеш и т.д.). Сейчас готовим UI и механику билетов.
  </div>

  <div class="seg lot-tabs" role="tablist" aria-label="Розыгрыши">
    <button type="button" class="is-active" data-lot-tab="active">Активные</button>
    <button type="button" data-lot-tab="archive">Архив</button>
    <button type="button" data-lot-tab="mine">Мои билеты</button>
  </div>

  <div class="lot-pane is-active" data-lot-pane="active">
<div class="lot-hero" aria-label="Активный розыгрыш (UI-заготовка)">
  <div class="left">
    <div class="badge">АКТИВНО • РОЗЫГРЫШ НЕДЕЛИ</div>
    <div class="title">iPhone 17 Pro</div>
    <div class="sub">Билеты от ₽100 • таймер и механика билетов подключим позже (сейчас — UI).</div>
    <div class="prog">
      <div class="bar"><div class="fill"></div></div>
      <div class="meta-line">
        <span>Продано: <b>340 / 1000</b></span>
        <span>Банк: <b>₽34 000</b></span>
        <span>Финиш: <b>скоро</b></span>
      </div>
    </div>
  </div>
  <div class="right">
    <div class="count">
      <div class="k">Ближайшее завершение</div>
      <div class="v">скоро</div>
    </div>
    <button class="btn primary" type="button" disabled style="opacity:.6; cursor:not-allowed">Купить билет (soon)</button>
  </div>
</div>
    <div class="lotteries">
    <div class="stake-chip lottery-card" aria-disabled="true">
      <div class="meta"><span class="tag">РОЗЫГРЫШ</span><span class="muted">iPhone</span></div>
      <div class="amt">iPhone 17 Pro</div>
      <div class="muted" style="font-size:12px">Билеты • таймер • карточка розыгрыша</div>
      <button class="btn ghost" type="button" disabled style="margin-top:10px; opacity:.6; cursor:not-allowed">Скоро</button>
    </div>

    <div class="stake-chip lottery-card" aria-disabled="true">
      <div class="meta"><span class="tag">РОЗЫГРЫШ</span><span class="muted">Авто</span></div>
      <div class="amt">Largus</div>
      <div class="muted" style="font-size:12px">Билеты • таймер • карточка розыгрыша</div>
      <button class="btn ghost" type="button" disabled style="margin-top:10px; opacity:.6; cursor:not-allowed">Скоро</button>
    </div>

    <div class="stake-chip lottery-card" aria-disabled="true">
      <div class="meta"><span class="tag">РОЗЫГРЫШ</span><span class="muted">Cash</span></div>
      <div class="amt">Денежный приз</div>
      <div class="muted" style="font-size:12px">Билеты • таймер • карточка розыгрыша</div>
      <button class="btn ghost" type="button" disabled style="margin-top:10px; opacity:.6; cursor:not-allowed">Скоро</button>
    </div>
  </div>
  </div>

  <div class="lot-pane" data-lot-pane="archive">
<div class="lot-empty">
  <div class="title">Архив розыгрышей</div>
  <div class="muted" style="font-size:13px">Пока данные не подключены — но UI уже готов к «живому» архиву.</div>

  <table class="lot-table" aria-label="Архив розыгрышей (заглушка)">
    <thead>
      <tr>
        <th style="width:120px">Дата</th>
        <th>Приз</th>
        <th style="width:160px">Победитель</th>
        <th style="width:140px">Билеты</th>
        <th style="width:140px">Проверка</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="muted">—</td>
        <td>—</td>
        <td><span class="pill">—</span></td>
        <td class="muted">—</td>
        <td class="muted">seed/nonce/commit</td>
      </tr>
      <tr>
        <td class="muted">—</td>
        <td>—</td>
        <td><span class="pill">—</span></td>
        <td class="muted">—</td>
        <td class="muted">seed/nonce/commit</td>
      </tr>
    </tbody>
  </table>
</div>
</div>

  <div class="lot-pane" data-lot-pane="mine">
    <div class="lot-empty">
  <div class="title">Мои билеты</div>
  <div class="muted" style="font-size:13px">Будет история билетов: сколько куплено, статус, выигрыш. Пока — UI-заготовка.</div>

  <div class="lot-row" style="margin-top:12px">
    <div class="r"><div><div class="k">Активных билетов</div><div class="v">—</div></div><div class="muted" style="font-size:12px">скоро</div></div>
  </div>

  <table class="lot-table" aria-label="Мои билеты (заглушка)">
    <thead>
      <tr>
        <th style="width:160px">Розыгрыш</th>
        <th style="width:120px">Билетов</th>
        <th style="width:140px">Статус</th>
        <th>Комментарий</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>—</td>
        <td class="muted">—</td>
        <td><span class="pill">—</span></td>
        <td class="muted">данные появятся после подключения билетов</td>
      </tr>
    </tbody>
  </table>
</div></div><div class="muted" style="font-size:12px">скоро</div></div>
      </div>

      <div class="lot-row">
        <div class="r"><div><div class="k">Последний приз</div><div class="v">—</div></div><div class="muted" style="font-size:12px">скоро</div></div>
      </div>
    </div>
  </div>

  </div>
</div>
      </div>


        </div>
      </main>

      <aside class="rail" aria-label="Правая панель">
        <div class="card" id="rail-duels-pf">
          <h3>Provably fair</h3>
          <div class="small">
            Каждая дуэль имеет проверяемую «монетку»: commit → reveal → вычисление winner.
            В карточке дуэли можно увидеть seed/nonce/commit и повторить расчёт.
          </div>
        </div>

        <div class="card" id="rail-lottery-pf" style="display:none">
          <h3>Честность розыгрышей</h3>
          <div class="small">
            Розыгрыши будут отдельным режимом: прозрачные правила, публичные результаты,
            и проверяемый механизм выбора победителя (по аналогии с provably fair).
          </div>
        </div>

        <div class="card" id="rail-duels-status" style="margin-top:14px">
          <h3>Статус дуэлей</h3>
          <div class="small">Коротко о лобби прямо сейчас — чтобы не гадать, живо ли оно.</div>
          <div class="kpi">
            <div class="k"><div class="t">Открытых</div><div class="v" id="kpi-open">—</div></div>
            <div class="k"><div class="t">Моих open</div><div class="v" id="kpi-myopen">—</div></div>
            <div class="k"><div class="t">Архив</div><div class="v" id="kpi-history">—</div></div>
            <div class="k"><div class="t">Связи</div><div class="v" id="kpi-links">—</div></div>
          </div>
        </div>

        <div class="card" id="rail-lottery-status" style="margin-top:14px; display:none">
          <h3>Статус розыгрышей</h3>
          <div class="small">Здесь появятся активные розыгрыши и прогресс по билетам.</div>
          <div class="kpi">
            <div class="k"><div class="t">Активных</div><div class="v" id="kpi-lot-active">Скоро</div></div>
            <div class="k"><div class="t">Ближайший</div><div class="v" id="kpi-lot-next">Скоро</div></div>
            <div class="k"><div class="t">Мои билеты</div><div class="v" id="kpi-lot-mine">—</div></div>
            <div class="k"><div class="t">Призы</div><div class="v" id="kpi-lot-prizes">iPhone · авто · cash</div></div>
          </div>
        </div>
      </aside>
    </div>
  </div>


<!-- Детали дуэли -->

<div class="modal-backdrop" id="duel-modal">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title" id="duel-modal-title">Дуэль</div>
      <button class="modal-close" id="duel-modal-close">Закрыть</button>
    </div>
    <div class="modal-body">
      <div class="kv" id="duel-modal-kv"></div>
    </div>
  </div>
</div>


<!-- Создание комнаты (режимы) -->
<div class="modal-backdrop" id="create-modal">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">Создать комнату</div>
      <button class="modal-close" id="create-modal-close" type="button">Закрыть</button>
    </div>
    <div class="modal-body">
      <div class="muted" style="font-size:13px; line-height:1.4">
        Выбери формат. Сейчас полноценно работает только <b>публичная дуэль 1v1</b> — остальные режимы уже «на рельсах», но появятся чуть позже.
      </div>

      <div class="seg" role="tablist" aria-label="Режим комнаты">
        <button type="button" class="is-active" data-mode="duel_1v1_public">1v1</button>
        <button type="button" data-mode="duel_invite">Invite <span class="badge-soon" style="margin-left:6px">soon</span></button>
        <button type="button" data-mode="duel_multi">3/6/10 <span class="badge-soon" style="margin-left:6px">soon</span></button>
</div>

      <div class="mode-pane is-active" data-pane="duel_1v1_public">
        <div style="font-weight:900; margin-top:2px;">Публичная дуэль 1v1</div>
        <div class="muted" style="font-size:13px; margin-top:6px;">
          Комната попадёт в Live. Победитель определяется coinflip. Детали будут в карточке дуэли.
        </div>
      </div>

      <div class="mode-pane" data-pane="duel_invite">
        <div style="font-weight:900; margin-top:2px;">Приглашение конкретного игрока</div>
        <div class="muted" style="font-size:13px; margin-top:6px;">
          Приватная комната: видна только вам двоим, по приглашению. Отлично для «вызова».
        </div>
        <div class="field">
          <label for="invite-user-id">Кого приглашаем (user_id)</label>
          <input id="invite-user-id" type="number" min="1" placeholder="например: 97">
        </div>
      </div>

      <div class="mode-pane" data-pane="duel_multi">
        <div style="font-weight:900; margin-top:2px;">Комнаты на несколько участников</div>
        <div class="muted" style="font-size:13px; margin-top:6px;">
          Формат «на компанию»: 3 / 6 / 10 человек. Механика будет похожа, но с иным распределением побед.
        </div>
        <div class="field">
          <label for="multi-size">Количество участников</label>
          <select id="multi-size">
            <option value="3">3</option>
            <option value="6">6</option>
            <option value="10">10</option>
          </select>
        </div>
      </div>

    </div>

    <div class="modal-foot">
      <div class="left">Подготовительный UI-шаг: сохраняем выбор, но создаём пока только 1v1.</div>
      <div class="actions">
        <button class="btn" id="create-modal-cancel" type="button">Отмена</button>
        <button class="btn primary" id="create-modal-save" type="button">Сохранить режим</button>
        <button class="btn primary" id="create-modal-create" type="button">Создать сейчас</button>
      </div>
    </div>
  </div>
</div>


<!-- Монетка (3–4 секунды) -->
<div class="coin-overlay" id="coin-overlay">
  <div class="coin-card">
    <div style="font-weight:800; font-size:18px;">Монетка решает судьбу…</div>
    <div class="coin" aria-hidden="true"></div>
    <div class="coin-text">Секунду. Мы честно кидаем coinflip.</div>
  </div>
</div>

  <div class="toast" id="toast">
    <div class="t" id="toast-title"></div>
    <div class="b" id="toast-body"></div>
  </div>

  <!-- Telegram Login (асинхронно) -->
  <script async src="https://telegram.org/js/telegram-widget.js?22"></script>

  <!-- Весь JS — в одном файле. Он тянет HUM-баланс, делает proof-link и меняет кнопку на «… связан». -->
  <script src="/js/lobby-balance-fix.js"></script>

  <!-- Дуэли 1v1: список, создание, join/cancel -->
  <script src="/js/duels-lobby.js?v=12"></script>


  <script>
    // Подсветка активной вкладки (topbar + sidebar) по hash + переключение разделов
    (function(){
      const topLinks = Array.from(document.querySelectorAll('.hdr-nav a'));
      const sideLinks = Array.from(document.querySelectorAll('.side-nav a'));

      const mainTabs = Array.from(document.querySelectorAll('.hdr-main-tab[data-main]'));
      const hdrSubDuels = document.getElementById('hdr-sub-duels');
      const hdrSubLottery = document.getElementById('hdr-sub-lottery');

      const hubDuels = document.getElementById('hub-duels');
      const hubLottery = document.getElementById('hub-lottery');

      const railDuelsPF = document.getElementById('rail-duels-pf');
      const railLotteryPF = document.getElementById('rail-lottery-pf');
      const railDuelsStatus = document.getElementById('rail-duels-status');
      const railLotteryStatus = document.getElementById('rail-lottery-status');

const lotSub = document.getElementById('lottery-subnav');
const lotSideLinks = Array.from(document.querySelectorAll('[data-lot-jump]'));

if(lotSideLinks.length){
  lotSideLinks.forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      location.hash = '#lottery';
      const t = a.dataset.lotJump || 'active';
      if(typeof window.__gg_setLotteryTab === 'function'){
        window.__gg_setLotteryTab(t);
      } else {
        try{ localStorage.setItem('ggroom_lottery_tab_v1', t); }catch(_){}
      }
    });
  });
}

      // Кликабельные заголовки-группы/кнопки (чтобы по «Дуэли/Розыгрыши» всегда открывалось)
      const labelLinks = Array.from(document.querySelectorAll('[data-hash].is-click'));
      labelLinks.forEach(el=>{
        el.addEventListener('click', ()=>{
          const t = el.dataset.hash;
          if(!t) return;
          if(location.hash === t){
            // hash не меняется → браузер не всегда делает что-то заметное
            try{ window.dispatchEvent(new HashChangeEvent('hashchange')); }catch(_){ /* noop */ }
            const anchor = document.querySelector(t);
            if(anchor) anchor.scrollIntoView({ behavior:'smooth', block:'start' });
            return;
          }
          location.hash = t;
        });
        el.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter' || e.key === ' '){
            e.preventDefault();
            const t = el.dataset.hash;
            if(t) location.hash = t;
          }
        });
      });

      function norm(h){
        if(!h) return '#stakes';
        if(!h.startsWith('#')) return '#stakes';
        return h;
      }

      function update(){
        const h = norm(location.hash);

        // активные пункты меню
        topLinks.forEach(a => a.classList.toggle('is-active', a.getAttribute('href') === h));
        sideLinks.forEach(a => a.classList.toggle('is-active', a.getAttribute('href') === h));

        // разделы: Дуэли vs Розыгрыши
        const isLottery = (h === '#lottery' || h.startsWith('#lottery'));

        // верхняя навигация в 2 уровня: (Дуэли/Розыгрыши) + (подраздел)
        mainTabs.forEach(b => b.classList.toggle('is-active', b.dataset.main === (isLottery ? 'lottery' : 'duels')));
        if(hdrSubDuels) hdrSubDuels.style.display = isLottery ? 'none' : '';
        if(hdrSubLottery) hdrSubLottery.style.display = isLottery ? '' : 'none';

if(lotSub) lotSub.style.display = isLottery ? '' : 'none';
if(isLottery){
  const t = (typeof window.__gg_getLotteryTab === 'function')
    ? window.__gg_getLotteryTab()
    : (function(){ try{return localStorage.getItem('ggroom_lottery_tab_v1')||'active';}catch(e){return 'active';} })();
  lotSideLinks.forEach(a => a.classList.toggle('is-active', a.dataset.lotJump === t));
}

        if (hubDuels) hubDuels.style.display = isLottery ? 'none' : '';
        if (hubLottery) hubLottery.style.display = isLottery ? '' : 'none';

        // правая панель тоже меняется
        if (railDuelsPF) railDuelsPF.style.display = isLottery ? 'none' : '';
        if (railDuelsStatus) railDuelsStatus.style.display = isLottery ? 'none' : '';
        if (railLotteryPF) railLotteryPF.style.display = isLottery ? '' : 'none';
        if (railLotteryStatus) railLotteryStatus.style.display = isLottery ? '' : 'none';
      }

      window.addEventListener('hashchange', update);
      update();
    })();

      // ===== Step 1.6.2: lottery tabs (Активные / Архив / Мои билеты) =====
      (function(){
        const btns = Array.from(document.querySelectorAll('[data-lot-tab]'));
        const panes = Array.from(document.querySelectorAll('[data-lot-pane]'));
        if(!btns.length || !panes.length) return;

        const LS_KEY = 'ggroom_lottery_tab_v1';
        function getTab(){
          try{ return localStorage.getItem(LS_KEY) || 'active'; }catch(e){ return 'active'; }
        }
        function setTab(t){
          btns.forEach(b => b.classList.toggle('is-active', b.dataset.lotTab === t));
          panes.forEach(p => p.classList.toggle('is-active', p.dataset.lotPane === t));
          try{ localStorage.setItem(LS_KEY, t); }catch(e){}
        }

        btns.forEach(b => b.addEventListener('click', ()=> setTab(b.dataset.lotTab)));

        // expose для сайдбара/других блоков
        window.__gg_setLotteryTab = setTab;
        window.__gg_getLotteryTab = getTab;

        function syncOnEnter(){
          const h = (location.hash || '#stakes');
          const isLottery = (h === '#lottery' || h.startsWith('#lottery'));
          if(isLottery) setTab(getTab());
        }

        window.addEventListener('hashchange', syncOnEnter);
        syncOnEnter();
      })();
  </script>


  <script>
    // ===== Step 1.5: режимы комнат (UI-слой, без изменения логики 1v1) =====
    (function(){
      const $ = (s, r=document) => r.querySelector(s);

      const btnCreate = $('#duels-create');
      const btnMode = $('#create-mode-btn');
      const linkMode = $('#create-mode-link');
      const pillMode = $('#create-mode-pill');

      const modal = $('#create-modal');
      const closeBtn = $('#create-modal-close');
      const cancelBtn = $('#create-modal-cancel');
      const saveBtn = $('#create-modal-save');
      const createNowBtn = $('#create-modal-create');

      const segBtns = Array.from(modal.querySelectorAll('.seg button[data-mode]'));
      const panes = Array.from(modal.querySelectorAll('.mode-pane[data-pane]'));

      const inviteInput = $('#invite-user-id');
      const multiSize = $('#multi-size');

      const LS_KEY = 'ggroom_create_mode_v1';

      function toast(title, body){
        // Если в проекте уже есть showToast — используем его.
        if (typeof window.showToast === 'function') return window.showToast(title, body);

        const t = $('#toast'); const tt = $('#toast-title'); const tb = $('#toast-body');
        if(!t || !tt || !tb) return;
        tt.textContent = title || '';
        tb.textContent = body || '';
        t.classList.add('show');
        clearTimeout(window.__gg_toast_timer);
        window.__gg_toast_timer = setTimeout(()=>t.classList.remove('show'), 3800);
      }

      function openModal(){ modal.style.display='flex'; }
      function closeModal(){ modal.style.display='none'; }

      function getMode(){
        try{
          const raw = localStorage.getItem(LS_KEY);
          if(raw){
            const m = JSON.parse(raw);
            if(m && m.type === 'lottery') return { type:'duel_1v1_public' };
            return m;
          }
        }catch(e){}
        return { type:'duel_1v1_public' };
      }

      function setMode(m){
        try{ localStorage.setItem(LS_KEY, JSON.stringify(m)); }catch(e){}
        renderMode();
      }

      function setActiveMode(type){
        segBtns.forEach(b => b.classList.toggle('is-active', b.dataset.mode === type));
        panes.forEach(p => p.classList.toggle('is-active', p.dataset.pane === type));
      }

      function renderMode(){
        const m = getMode();
        const map = {
          duel_1v1_public: { tag:'1v1', text:'Публичная дуэль' },
          duel_invite: { tag:'INV', text:`Приглашение${m.invite_user_id ? `: #${m.invite_user_id}` : ''}` },
          duel_multi: { tag:'MULTI', text:`Комната на ${m.seats || 3}` },
};
        const x = map[m.type] || map.duel_1v1_public;
        pillMode.innerHTML = `<span class="tag">${x.tag}</span> ${x.text}`;
        setActiveMode(m.type);

        // Если режим не 1v1 — меняем лейбл кнопки (но не лезем в расчёты/запросы)
        if(m.type !== 'duel_1v1_public'){
          btnCreate.classList.remove('primary');
          btnCreate.classList.add('danger');
          btnCreate.textContent = 'Создать (скоро)';
        } else {
          btnCreate.classList.remove('danger');
          btnCreate.classList.add('primary');
          btnCreate.textContent = 'Создать комнату';
        }
      }

      // переключение табов в модалке
      segBtns.forEach(b => b.addEventListener('click', ()=>{
        const type = b.dataset.mode;
        setActiveMode(type);
      }));

      // открыть модалку
      function openFromUI(e){ e.preventDefault(); openModal(); }
      btnMode.addEventListener('click', openFromUI);
      linkMode.addEventListener('click', openFromUI);

      // закрытие
      closeBtn.addEventListener('click', closeModal);
      cancelBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal.style.display === 'flex') closeModal(); });

      function collectSelected(){
        const active = segBtns.find(b=>b.classList.contains('is-active'));
        const type = active ? active.dataset.mode : 'duel_1v1_public';
        const m = { type };

        if(type === 'duel_invite'){
          const v = parseInt(inviteInput.value || '', 10);
          if(Number.isFinite(v) && v > 0) m.invite_user_id = v;
        }
        if(type === 'duel_multi'){
          const seats = parseInt(multiSize.value || '3', 10);
          m.seats = Number.isFinite(seats) ? seats : 3;
        }
        return m;
      }

      saveBtn.addEventListener('click', ()=>{
        const m = collectSelected();
        setMode(m);
        closeModal();

        if(m.type !== 'duel_1v1_public'){
          toast('Режим сохранён', 'Этот формат пока в разработке. Сейчас создаём только публичные дуэли 1v1.');
        } else {
          toast('Режим сохранён', 'Публичная дуэль 1v1.');
        }
      });

      createNowBtn.addEventListener('click', ()=>{
        const m = collectSelected();
        setMode(m);
        closeModal();

        if(m.type !== 'duel_1v1_public'){
          toast('Скоро', 'Этот формат появится чуть позже. Сейчас доступна только публичная дуэль 1v1.');
          return;
        }
        // Важно: НЕ трогаем логику создания — просто жмём существующую кнопку.
        btnCreate.click();
      });

      // блокируем создание, если выбран неподдерживаемый режим (без правок duels-lobby.js)
      btnCreate.addEventListener('click', (e)=>{
        const m = getMode();
        if(m.type !== 'duel_1v1_public'){
          e.preventDefault();
          e.stopImmediatePropagation();
          toast('Скоро', 'Выбранный режим пока не активен. Переключи на «Публичная дуэль 1v1».');
        }
      }, true);

      // init
      renderMode();
    })();
  </script>


  <script defer src="/gg-linker.js"></script>
</body>
</html>
